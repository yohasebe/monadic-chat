<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Install Options</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { display:flex; flex-direction:column; height:100vh; margin:0; padding:0; color:#333; background:#eeeeee; overflow:hidden; }
    body, input, button, label { font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans CJK JP', 'Yu Gothic', sans-serif; }
    h1 { margin:10px; font-size:14px; font-weight:600; }
    #container { flex-grow:1; overflow-y:auto; padding:0 10px; height:calc(100vh - 55px); }
    .category { margin-bottom:20px; padding:15px; background:#f9f9f9; border-radius:8px; border-left:4px solid #2196F3; }
    .category h2 { font-size:13px; margin:0 0 12px 0; padding-bottom:6px; border-bottom:1px solid #e0e0e0; color:#555; }
    .category h2 i { margin-right:8px; color:#2196F3; }
    .row { display:flex; align-items:center; gap:8px; margin:6px 0; font-size:12px; }
    .row .item-label { display:inline-block; white-space:normal; }
    .help { color:#6b7280; font-size:11px; }
    input[type="checkbox"] { transform: scale(0.9); }
    .button-group { border-top:1px solid #ccc; padding:12px; background:#eeeeee; display:flex; gap:8px; }
    .button-group button { background:#ffc107; color:#000; border:none; border-radius:5px; padding:6px 12px; cursor:pointer; font-size:13px; height:30px; display:inline-flex; align-items:center; justify-content:center; }
    .button-group button:hover { background:#e0ac07; }
    .fa-icon { margin-right:6px; }
    #io-save-message { display:none; color:#28a745; margin-left:10px; font-size:18px; vertical-align:middle; }
    #io-save-message i { animation: checkmark 0.5s ease-in-out; }
    @keyframes checkmark { 0% { transform: scale(0); opacity:0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity:1; } }
  </style>
  <script>
    let ioDirty = false;
    let ioTranslationsAll = null;
    let ioInitialSnapshot = '';
    const ioIds = ['INSTALL_LATEX','PYOPT_NLTK','PYOPT_SPACY','PYOPT_SCIKIT','PYOPT_GENSIM','PYOPT_LIBROSA','PYOPT_MEDIAPIPE','PYOPT_TRANSFORMERS','IMGOPT_IMAGEMAGICK','SELENIUM_ENABLED'];
    const takeIoSnapshot = () => {
      const obj = {};
      ioIds.forEach(id => { obj[id] = !!document.getElementById(id)?.checked; });
      return JSON.stringify(obj);
    };
    function detectLang(){
      try {
        const m = document.cookie.match(/ui-language=([^;]+)/);
        if (m && m[1]) return m[1];
      } catch(e) {}
      const n=(navigator.language||'en').slice(0,2);
      return n || 'en';
    }
    async function loadPanelTranslations() {
      const lang = detectLang();
      const all = await window.electronAPI.getTranslations(lang);
      ioTranslationsAll = all || {};
      const t = (all && all.installOptionsPanel) ? all.installOptionsPanel : null;
      return t;
    }
    function applyTranslations(t){
      if (!t) return;
      const get = (path, def='') => {
        try { return path.split('.').reduce((o,k)=> (o||{})[k], t) || def; } catch(e){ return def; }
      };
      // Window title
      try { document.title = get('title','Install Options'); } catch {}
      document.getElementById('io-title').textContent = get('title','Install Options');
      // LaTeX
      document.getElementById('head-latex-text').textContent = get('categories.latex.title','LaTeX');
      document.getElementById('help-latex').textContent = get('categories.latex.help','');
      // Python
      document.getElementById('head-pylibs-text').textContent = get('categories.python.title','Python Libraries (CPU)');
      document.getElementById('help-pylibs').textContent = get('categories.python.help','');
      document.querySelector('label[for=INSTALL_LATEX]')?.lastChild && (document.querySelector('label[for=INSTALL_LATEX]').lastChild.textContent = '');
      // Tools
      document.getElementById('head-tools-text').textContent = get('categories.tools.title','System Tools (CLI)');
      document.getElementById('help-tools').textContent = get('categories.tools.help','');
      // Web
      document.getElementById('head-web-text').textContent = get('categories.web.title','Web Scraping');
      document.getElementById('help-web').textContent = get('categories.web.help','');
      // Items
      document.querySelector('label[for=INSTALL_LATEX] span.item-label')?.replaceWith((() => { const s=document.createElement('span'); s.className='item-label'; s.textContent=get('categories.latex.items.install'); return s; })());
      const setLabel = (id, key, def) => {
        const lab = document.querySelector(`label[for=${id}] span.item-label`);
        if (lab) lab.textContent = get(key, def);
      };
      setLabel('PYOPT_NLTK','categories.python.items.nltk','nltk');
      setLabel('PYOPT_SPACY','categories.python.items.spacy','spaCy (3.7.5)');
      setLabel('PYOPT_SCIKIT','categories.python.items.scikit','scikit-learn');
      setLabel('PYOPT_GENSIM','categories.python.items.gensim','gensim');
      setLabel('PYOPT_LIBROSA','categories.python.items.librosa','librosa');
      setLabel('PYOPT_MEDIAPIPE','categories.python.items.mediapipe','mediapipe (CPU)');
      setLabel('PYOPT_TRANSFORMERS','categories.python.items.transformers','transformers (CPU only)');
      setLabel('IMGOPT_IMAGEMAGICK','categories.tools.items.imagemagick','ImageMagick (convert/mogrify)');
      setLabel('SELENIUM_ENABLED','categories.web.items.selenium','Enable Selenium container');
      // Buttons
      document.getElementById('btn-close-text').textContent = get('buttons.close','Close');
      document.getElementById('btn-save-text').textContent = get('buttons.save','Save');
      // Save check tooltip
      const sm = document.getElementById('io-save-message');
      if (sm) sm.setAttribute('title', get('messages.saved', 'Options saved'));
    }
    // Re-run translation on demand (called by main process after setting cookie)
    async function installOptionsReloadTranslations() {
      const panelT = await loadPanelTranslations();
      applyTranslations(panelT);
    }
    async function loadOptions() {
      try {
        const panelT = await loadPanelTranslations();
        applyTranslations(panelT);
        const opts = await window.installOptionsAPI.get();
        const ids = [
          'INSTALL_LATEX','PYOPT_NLTK','PYOPT_SPACY','PYOPT_SCIKIT','PYOPT_GENSIM','PYOPT_LIBROSA',
          'PYOPT_MEDIAPIPE','PYOPT_TRANSFORMERS','IMGOPT_IMAGEMAGICK','SELENIUM_ENABLED'
        ];
        ids.forEach(id => { const el = document.getElementById(id); if (el) el.checked = !!opts[id]; });
      } catch(e) { console.error(e); }
    }
    async function saveOptions() {
      const saveBtn = document.getElementById('btn-save');
      if (saveBtn.dataset.saving === 'true') { return; }
      saveBtn.dataset.saving = 'true';
      saveBtn.disabled = true;
      const grab = id => !!document.getElementById(id)?.checked;
      const payload = {
        INSTALL_LATEX: grab('INSTALL_LATEX'),
        PYOPT_NLTK: grab('PYOPT_NLTK'),
        PYOPT_SPACY: grab('PYOPT_SPACY'),
        PYOPT_SCIKIT: grab('PYOPT_SCIKIT'),
        PYOPT_GENSIM: grab('PYOPT_GENSIM'),
        PYOPT_LIBROSA: grab('PYOPT_LIBROSA'),
        PYOPT_MEDIAPIPE: grab('PYOPT_MEDIAPIPE'),
        PYOPT_TRANSFORMERS: grab('PYOPT_TRANSFORMERS'),
        IMGOPT_IMAGEMAGICK: grab('IMGOPT_IMAGEMAGICK'),
        SELENIUM_ENABLED: grab('SELENIUM_ENABLED')
      };
      try {
        await window.installOptionsAPI.save(payload);
        const saveMsg = document.getElementById('io-save-message');
        // Set translated tooltip
        try {
          const panelT = (ioTranslationsAll && ioTranslationsAll.installOptionsPanel) ? ioTranslationsAll.installOptionsPanel : null;
          if (panelT && saveMsg) {
            const get = (path, def='') => { try { return path.split('.').reduce((o,k)=> (o||{})[k], panelT) || def; } catch(e){ return def; } };
            saveMsg.setAttribute('title', get('messages.saved','Options saved'));
          }
        } catch{}
        if (saveMsg) { saveMsg.style.display = 'inline-block'; }
        // Keep panel open; hide checkmark and re-enable save after delay
        setTimeout(() => {
          if (saveMsg) saveMsg.style.display = 'none';
          saveBtn.disabled = false;
          saveBtn.dataset.saving = 'false';
        }, 1200);
        ioInitialSnapshot = takeIoSnapshot();
        ioDirty = false;
      } catch(e) {
        alert('Failed to save: ' + e.message);
        saveBtn.disabled = false;
        saveBtn.dataset.saving = 'false';
      }
    }
    function showIoUnsavedDialog(onSave) {
      const d = (ioTranslationsAll && ioTranslationsAll.dialogs) ? ioTranslationsAll.dialogs : {};
      const title = d.unsavedChangesTitle || 'Unsaved Changes';
      const message = d.unsavedChangesMessage || 'You have unsaved changes. Save before closing?';
      const saveAndClose = d.saveAndClose || 'Save and Close';
      const cancel = d.cancel || 'Cancel';
      const html = `
        <div id="ioUnsavedDialog" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 2000; display:flex; align-items:center; justify-content:center;">
          <div style="background:#f8f9fa; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.2); padding:20px; max-width:420px; font-family: 'Montserrat', sans-serif;">
            <h3 style="margin-top:0; color:#495057; font-size:16px; font-weight:600;">${title}</h3>
            <p style="margin-bottom:20px; color:#495057; font-weight:normal; font-size:14px;">${message}</p>
            <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
              <button id="ioUnsavedCancel" style="background:#ddd; border:none; padding:6px 12px; border-radius:4px; color:#000; cursor:pointer; font-weight:500; font-size:13px;">${cancel}</button>
              <button id="ioUnsavedSave" style="background:#ffc107; border:none; padding:6px 12px; border-radius:4px; color:#000; cursor:pointer; font-weight:600; font-size:13px;">${saveAndClose}</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('ioUnsavedCancel').addEventListener('click', () => {
        document.getElementById('ioUnsavedDialog')?.remove();
      });
      document.getElementById('ioUnsavedSave').addEventListener('click', async () => {
        try { await onSave?.(); } finally {
          document.getElementById('ioUnsavedDialog')?.remove();
          if (window.installOptionsWindowAPI) {
            window.installOptionsWindowAPI.confirmClose();
          } else {
            window.close();
          }
        }
      });
    }
    function handleCloseClick(){
      // recompute dirty from snapshot
      ioDirty = (takeIoSnapshot() !== ioInitialSnapshot);
      if (!ioDirty) { 
        if (window.installOptionsWindowAPI) { window.installOptionsWindowAPI.confirmClose(); } else { window.close(); }
        return; 
      }
      showIoUnsavedDialog(() => saveOptions());
    }
    async function loadOptions(){
      try {
        const t = await loadPanelTranslations();
        applyTranslations(t);
        const opts = await window.installOptionsAPI.get();
        ioIds.forEach(id => { const el = document.getElementById(id); if (el) el.checked = !!opts[id]; });
        // attach dirty trackers
        document.querySelectorAll('input[type="checkbox"]').forEach(el => {
          el.addEventListener('change', () => { ioDirty = (takeIoSnapshot() !== ioInitialSnapshot); });
        });
        ioInitialSnapshot = takeIoSnapshot();
        ioDirty = false;
      } catch(e) { console.error(e); }
    }
    // OS close attempts
    if (window.installOptionsWindowAPI && window.installOptionsWindowAPI.onAttemptClose) {
      window.installOptionsWindowAPI.onAttemptClose(() => {
        const dirty = (takeIoSnapshot() !== ioInitialSnapshot);
        if (dirty) {
          showIoUnsavedDialog(() => saveOptions());
        } else {
          window.installOptionsWindowAPI.confirmClose();
        }
      });
    }
    window.addEventListener('DOMContentLoaded', loadOptions);
    // React to UI language changes broadcast from main
    if (window.electronAPI && window.electronAPI.onUILanguageChanged) {
      window.electronAPI.onUILanguageChanged((_e, data) => {
        try {
          if (data && data.language) {
            document.cookie = `ui-language=${data.language}; path=/; max-age=31536000`;
          }
        } catch {}
        installOptionsReloadTranslations();
      });
    }
  </script>
  </head>
  <body>
    <h1>Monadic Chat <span style="font-weight: normal;" id="io-title">Install Options</span></h1>
    <div id="container">
      <div class="category">
        <h2><i class="fa-solid fa-diagram-project"></i> <span id="head-latex-text">LaTeX</span></h2>
        <label class="row" for="INSTALL_LATEX"><input type="checkbox" id="INSTALL_LATEX" /> <span class="item-label">Install LaTeX (minimal set for diagrams)</span></label>
        <div class="help" id="help-latex">Required for Concept Visualizer / Syntax Tree</div>
      </div>
      <div class="category" style="border-left-color:#4CAF50;">
        <h2><i class="fa-solid fa-boxes-stacked" style="color:#4CAF50;"></i> <span id="head-pylibs-text">Python Libraries (CPU)</span></h2>
        <label class="row" for="PYOPT_NLTK"><input type="checkbox" id="PYOPT_NLTK" /> <span class="item-label">nltk</span></label>
        <label class="row" for="PYOPT_SPACY"><input type="checkbox" id="PYOPT_SPACY" /> <span class="item-label">spaCy (3.7.5)</span></label>
        <label class="row" for="PYOPT_SCIKIT"><input type="checkbox" id="PYOPT_SCIKIT" /> <span class="item-label">scikit-learn</span></label>
        <label class="row" for="PYOPT_GENSIM"><input type="checkbox" id="PYOPT_GENSIM" /> <span class="item-label">gensim</span></label>
        <label class="row" for="PYOPT_LIBROSA"><input type="checkbox" id="PYOPT_LIBROSA" /> <span class="item-label">librosa</span></label>
        <label class="row" for="PYOPT_MEDIAPIPE"><input type="checkbox" id="PYOPT_MEDIAPIPE" /> <span class="item-label">mediapipe (CPU)</span></label>
        <label class="row" for="PYOPT_TRANSFORMERS"><input type="checkbox" id="PYOPT_TRANSFORMERS" /> <span class="item-label">transformers (CPU only)</span></label>
        <div class="help" id="help-pylibs">Pip-installed libraries for Python runtime. Models/datasets are not included; add them via your pysetup.sh if needed.</div>
      </div>
      <div class="category" style="border-left-color:#9C27B0;">
        <h2><i class="fa-solid fa-wrench" style="color:#9C27B0;"></i> <span id="head-tools-text">System Tools (CLI)</span></h2>
        <label class="row" for="IMGOPT_IMAGEMAGICK"><input type="checkbox" id="IMGOPT_IMAGEMAGICK" /> <span class="item-label">ImageMagick (convert/mogrify)</span></label>
        <div class="help" id="help-tools">OS-level command-line tools available system-wide.</div>
      </div>
      <div class="category" style="border-left-color:#FF9800;">
        <h2><i class="fa-solid fa-spider" style="color:#FF9800;"></i> <span id="head-web-text">Web Scraping</span></h2>
        <label class="row" for="SELENIUM_ENABLED"><input type="checkbox" id="SELENIUM_ENABLED" /> <span class="item-label">Enable Selenium container</span></label>
        <div class="help" id="help-web">If disabled and Tavily API key is present, From URL will use Tavily. Otherwise #url/#doc buttons are hidden.</div>
      </div>
    </div>
    <div class="button-group">
      <button id="btn-save" onclick="saveOptions()"><i class="fa-solid fa-floppy-disk fa-icon"></i><span id="btn-save-text">Save</span></button>
      <button id="btn-close" onclick="handleCloseClick()"><i class="fa-solid fa-xmark fa-icon"></i><span id="btn-close-text">Close</span></button>
      <span id="io-save-message" title="Settings saved"><i class="fas fa-check-circle"></i></span>
    </div>
  </body>
</html>
