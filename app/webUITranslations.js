// Web UI Translations
const webUITranslations = {
  en: {
    ui: {
      start: "Start",
      stop: "Stop",
      restart: "Restart",
      rebuild: "Rebuild",
      update: "Update",
      openBrowser: "Browser",
      sharedFolder: "Shared Folder",
      quit: "Quit",
      mode: "Mode",
      docker: "Docker",
      system: "System",
      send: "Send",
      clear: "Clear",
      voice: "Voice",
      settings: "Settings",
      run: "Run",
      version: "Version",
      conversationLanguage: "Conversation Language",
      voiceChatControls: "Voice Chat Interaction Controls",
      currentBaseApp: "Current Base App",
      selectApp: "Select App",
      searchApps: "Search apps...",
      availableApps: "Available Apps",
      notStarted: "Not started",
      notSelected: "Not selected",
      notConfigured: "Not configured",
      noDataAvailable: "No data available",
      reset: "Reset",
      import: "Import",
      export: "Export",
      homepage: "Homepage",
      cancelQuery: "Cancel Query",
      toggleMenu: "Toggle Menu",
      status: "Status",
      mode: "Mode",
      standalone: "Standalone",
      server: "Server",
      network: "Network",
      textToSpeechProvider: "Text-to-Speech Provider",
      speechToTextProvider: "Speech-to-Text Provider",
      appCategories: {
        general: "General",
        specialized: "Specialized",
        tools: "Tools"
      },
      messages: {
        starting: "Starting Docker containers...",
        stopping: "Stopping Docker containers...",
        restarting: "Restarting Docker containers...",
        rebuilding: "Rebuilding Docker containers...",
        updating: "Updating Docker containers...",
        ready: "Ready",
        error: "Error",
        connecting: "Connecting..."
      }
    }
  },
  ja: {
    ui: {
      start: "開始",
      stop: "停止",
      restart: "再起動",
      rebuild: "再構築",
      update: "更新",
      openBrowser: "ブラウザ",
      sharedFolder: "共有フォルダ",
      quit: "終了",
      mode: "モード",
      docker: "Docker",
      system: "システム",
      send: "送信",
      clear: "クリア",
      voice: "音声",
      settings: "設定",
      run: "実行",
      version: "バージョン",
      conversationLanguage: "会話言語",
      voiceChatControls: "音声チャット操作コントロール",
      currentBaseApp: "現在のアプリ",
      selectApp: "アプリを選択",
      searchApps: "アプリを検索...",
      availableApps: "利用可能なアプリ",
      notStarted: "未開始",
      notSelected: "未選択",
      notConfigured: "未設定",
      noDataAvailable: "データなし",
      reset: "リセット",
      import: "インポート",
      export: "エクスポート",
      homepage: "ホームページ",
      cancelQuery: "クエリをキャンセル",
      toggleMenu: "メニュー切替",
      status: "ステータス",
      mode: "モード",
      standalone: "スタンドアロン",
      server: "サーバー",
      network: "ネットワーク",
      textToSpeechProvider: "テキスト読み上げプロバイダー",
      speechToTextProvider: "音声認識プロバイダー",
      appCategories: {
        general: "一般",
        specialized: "専門",
        tools: "ツール"
      },
      messages: {
        starting: "Dockerコンテナを起動しています...",
        stopping: "Dockerコンテナを停止しています...",
        restarting: "Dockerコンテナを再起動しています...",
        rebuilding: "Dockerコンテナを再構築しています...",
        updating: "Dockerコンテナを更新しています...",
        ready: "準備完了",
        error: "エラー",
        connecting: "接続中..."
      }
    }
  },
  zh: {
    ui: {
      start: "启动",
      stop: "停止",
      restart: "重启",
      rebuild: "重建",
      update: "更新",
      openBrowser: "浏览器",
      sharedFolder: "共享文件夹",
      quit: "退出",
      send: "发送",
      clear: "清除",
      voice: "语音",
      settings: "设置",
      run: "运行",
      version: "版本",
      conversationLanguage: "对话语言",
      voiceChatControls: "语音聊天交互控制",
      currentBaseApp: "当前应用",
      selectApp: "选择应用",
      searchApps: "搜索应用...",
      availableApps: "可用应用",
      notStarted: "未启动",
      notSelected: "未选择",
      notConfigured: "未配置",
      noDataAvailable: "无数据",
      reset: "重置",
      import: "导入",
      export: "导出",
      homepage: "主页",
      cancelQuery: "取消查询",
      toggleMenu: "切换菜单",
      status: "状态",
      mode: "模式",
      standalone: "单机",
      server: "服务器",
      network: "网络",
      textToSpeechProvider: "文本转语音提供商",
      speechToTextProvider: "语音转文本提供商",
      appCategories: {
        general: "通用",
        specialized: "专业",
        tools: "工具"
      },
      messages: {
        starting: "正在启动Docker容器...",
        stopping: "正在停止Docker容器...",
        restarting: "正在重启Docker容器...",
        rebuilding: "正在重建Docker容器...",
        updating: "正在更新Docker容器...",
        ready: "就绪",
        error: "错误",
        connecting: "连接中..."
      }
    }
  },
  ko: {
    ui: {
      start: "시작",
      stop: "중지",
      restart: "재시작",
      rebuild: "재구축",
      update: "업데이트",
      openBrowser: "브라우저",
      sharedFolder: "공유 폴더",
      quit: "종료",
      send: "전송",
      clear: "지우기",
      voice: "음성",
      settings: "설정",
      run: "실행",
      version: "버전",
      conversationLanguage: "대화 언어",
      voiceChatControls: "음성 채팅 상호작용 컨트롤",
      currentBaseApp: "현재 앱",
      selectApp: "앱 선택",
      searchApps: "앱 검색...",
      availableApps: "사용 가능한 앱",
      notStarted: "시작 안 됨",
      notSelected: "선택 안 됨",
      notConfigured: "구성 안 됨",
      noDataAvailable: "데이터 없음",
      reset: "재설정",
      import: "가져오기",
      export: "내보내기",
      homepage: "홈페이지",
      cancelQuery: "쿼리 취소",
      toggleMenu: "메뉴 토글",
      status: "상태",
      mode: "모드",
      standalone: "독립형",
      server: "서버",
      network: "네트워크",
      textToSpeechProvider: "텍스트 음성 변환 제공자",
      speechToTextProvider: "음성 텍스트 변환 제공자",
      appCategories: {
        general: "일반",
        specialized: "전문",
        tools: "도구"
      },
      messages: {
        starting: "Docker 컨테이너를 시작하는 중...",
        stopping: "Docker 컨테이너를 중지하는 중...",
        restarting: "Docker 컨테이너를 재시작하는 중...",
        rebuilding: "Docker 컨테이너를 재구축하는 중...",
        updating: "Docker 컨테이너를 업데이트하는 중...",
        ready: "준비 완료",
        error: "오류",
        connecting: "연결 중..."
      }
    }
  },
  es: {
    ui: {
      start: "Iniciar",
      stop: "Detener",
      restart: "Reiniciar",
      rebuild: "Reconstruir",
      update: "Actualizar",
      openBrowser: "Navegador",
      sharedFolder: "Compartida",
      quit: "Salir",
      send: "Enviar",
      clear: "Limpiar",
      voice: "Voz",
      settings: "Configuración",
      run: "Ejecutar",
      version: "Versión",
      conversationLanguage: "Idioma de Conversación",
      voiceChatControls: "Controles de Interacción de Chat de Voz",
      currentBaseApp: "Aplicación Actual",
      selectApp: "Seleccionar App",
      searchApps: "Buscar apps...",
      availableApps: "Apps Disponibles",
      notStarted: "No iniciado",
      notSelected: "No seleccionado",
      notConfigured: "No configurado",
      noDataAvailable: "Sin datos",
      reset: "Reiniciar",
      import: "Importar",
      export: "Exportar",
      homepage: "Página principal",
      cancelQuery: "Cancelar consulta",
      toggleMenu: "Alternar menú",
      status: "Estado",
      mode: "Modo",
      standalone: "Independiente",
      server: "Servidor",
      network: "Red",
      textToSpeechProvider: "Proveedor de texto a voz",
      speechToTextProvider: "Proveedor de voz a texto",
      appCategories: {
        general: "General",
        specialized: "Especializado",
        tools: "Herramientas"
      },
      messages: {
        starting: "Iniciando contenedores Docker...",
        stopping: "Deteniendo contenedores Docker...",
        restarting: "Reiniciando contenedores Docker...",
        rebuilding: "Reconstruyendo contenedores Docker...",
        updating: "Actualizando contenedores Docker...",
        ready: "Listo",
        error: "Error",
        connecting: "Conectando..."
      }
    }
  },
  fr: {
    ui: {
      start: "Démarrer",
      stop: "Arrêter",
      restart: "Redémarrer",
      rebuild: "Reconstruire",
      update: "Mettre à jour",
      openBrowser: "Navigateur",
      sharedFolder: "Partagé",
      quit: "Quitter",
      mode: "Mode",
      docker: "Docker",
      system: "Système",
      send: "Envoyer",
      clear: "Effacer",
      voice: "Voix",
      settings: "Paramètres",
      run: "Exécuter",
      version: "Version",
      conversationLanguage: "Langue de Conversation",
      voiceChatControls: "Contrôles d'Interaction du Chat Vocal",
      currentBaseApp: "Application Actuelle",
      selectApp: "Sélectionner App",
      searchApps: "Rechercher apps...",
      availableApps: "Apps Disponibles",
      notStarted: "Non démarré",
      notSelected: "Non sélectionné",
      notConfigured: "Non configuré",
      noDataAvailable: "Aucune donnée",
      reset: "Réinitialiser",
      import: "Importer",
      export: "Exporter",
      homepage: "Page d'accueil",
      cancelQuery: "Annuler la requête",
      toggleMenu: "Basculer le menu",
      status: "État",
      mode: "Mode",
      standalone: "Autonome",
      server: "Serveur",
      network: "Réseau",
      textToSpeechProvider: "Fournisseur de synthèse vocale",
      speechToTextProvider: "Fournisseur de reconnaissance vocale",
      appCategories: {
        general: "Général",
        specialized: "Spécialisé",
        tools: "Outils"
      },
      messages: {
        starting: "Démarrage des conteneurs Docker...",
        stopping: "Arrêt des conteneurs Docker...",
        restarting: "Redémarrage des conteneurs Docker...",
        rebuilding: "Reconstruction des conteneurs Docker...",
        updating: "Mise à jour des conteneurs Docker...",
        ready: "Prêt",
        error: "Erreur",
        connecting: "Connexion..."
      }
    }
  },
  de: {
    ui: {
      start: "Starten",
      stop: "Stoppen",
      restart: "Neustart",
      rebuild: "Neuerstellen",
      update: "Aktualisieren",
      openBrowser: "Browser",
      sharedFolder: "Freigabe",
      quit: "Beenden",
      mode: "Modus",
      docker: "Docker",
      system: "System",
      send: "Senden",
      clear: "Löschen",
      voice: "Stimme",
      settings: "Einstellungen",
      run: "Ausführen",
      version: "Version",
      conversationLanguage: "Gesprächssprache",
      voiceChatControls: "Sprachchat-Interaktionssteuerung",
      currentBaseApp: "Aktuelle App",
      selectApp: "App Auswählen",
      searchApps: "Apps suchen...",
      availableApps: "Verfügbare Apps",
      notStarted: "Nicht gestartet",
      notSelected: "Nicht ausgewählt",
      notConfigured: "Nicht konfiguriert",
      noDataAvailable: "Keine Daten verfügbar",
      reset: "Zurücksetzen",
      import: "Importieren",
      export: "Exportieren",
      homepage: "Startseite",
      cancelQuery: "Anfrage abbrechen",
      toggleMenu: "Menü umschalten",
      status: "Status",
      mode: "Modus",
      standalone: "Eigenständig",
      server: "Server",
      network: "Netzwerk",
      textToSpeechProvider: "Text-zu-Sprache-Anbieter",
      speechToTextProvider: "Sprache-zu-Text-Anbieter",
      appCategories: {
        general: "Allgemein",
        specialized: "Spezialisiert",
        tools: "Werkzeuge"
      },
      messages: {
        starting: "Docker-Container werden gestartet...",
        stopping: "Docker-Container werden gestoppt...",
        restarting: "Docker-Container werden neu gestartet...",
        rebuilding: "Docker-Container werden neu erstellt...",
        updating: "Docker-Container werden aktualisiert...",
        ready: "Bereit",
        error: "Fehler",
        connecting: "Verbindung wird hergestellt..."
      }
    }
  }
};

// Compatibility: Provide a browser-friendly I18n when Node-based app/i18n.js is unavailable
// (e.g., nodeIntegration=false). This wrapper mirrors the minimal API used by mainScreen.js:
//   - new I18n();
//   - setLanguage(lang)
//   - t(key, params)
// It sources messages from webUITranslations above.
(function () {
  if (typeof window === 'undefined') return;
  if (typeof window.I18n === 'undefined') {
    class I18n {
      constructor() {
        this.currentLanguage = 'en';
        this.translations = webUITranslations;
      }
      setLanguage(language) {
        if (this.translations[language]) {
          this.currentLanguage = language;
          return true;
        }
        console.warn(`Language ${language} not found, using English`);
        this.currentLanguage = 'en';
        return false;
      }
      t(key, replacements = {}) {
        // Resolve nested keys like 'ui.messages.starting'
        const parts = String(key).split('.');
        let value = this.translations[this.currentLanguage];
        let fallback = this.translations['en'];
        for (const p of parts) {
          value = value && value[p];
          fallback = fallback && fallback[p];
          if (!value && !fallback) return key;
        }
        let result = (value || fallback || key);
        // Simple placeholder replacement: {{name}}
        Object.keys(replacements || {}).forEach((name) => {
          const re = new RegExp(`{{${name}}}`, 'g');
          result = String(result).replace(re, replacements[name]);
        });
        return result;
      }
    }
    window.I18n = I18n;
    // Auto-initialize if not present to reduce race conditions
    if (!window.i18n) {
      try {
        const inst = new I18n();
        // Try cookie-based language
        const m = document.cookie && document.cookie.match(/ui-language=([^;]+)/);
        if (m && m[1]) inst.setLanguage(m[1]);
        window.i18n = inst;
      } catch (_) { /* no-op */ }
    }
  }
})();

// Web UI i18n helper class
class WebUIi18n {
  constructor() {
    this.currentLanguage = 'en';
    this.translations = webUITranslations;
  }

  setLanguage(language) {
    if (this.translations[language]) {
      this.currentLanguage = language;
      this.updateUIText();
      return true;
    }
    console.warn(`Language ${language} not found, using English`);
    this.currentLanguage = 'en';
    return false;
  }

  t(key) {
    const keys = key.split('.');
    let value = this.translations[this.currentLanguage];
    let fallback = this.translations['en'];
    
    for (const k of keys) {
      value = value?.[k];
      fallback = fallback?.[k];
      
      if (!value && !fallback) {
        return key;
      }
    }
    
    return value || fallback || key;
  }

  updateUIText() {
    console.log('[WebUITranslations] Updating UI text for language:', this.currentLanguage);
    // Update elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(element => {
      const key = element.getAttribute('data-i18n');
      const translation = this.t(key);
      
      if (element.tagName === 'INPUT' && element.type === 'button') {
        element.value = translation;
      } else if (element.placeholder !== undefined) {
        element.placeholder = translation;
      } else if (element.tagName === 'BUTTON') {
        // Special handling for buttons with icons and spans
        const icon = element.querySelector('i');
        const span = element.querySelector('span');
        if (icon && span) {
          // Update only the text span, preserve the icon
          console.log(`[WebUITranslations] Updating button ${element.id}: ${span.textContent} -> ${translation}`);
          span.textContent = translation;
        } else if (icon) {
          // If there's an icon but no span, update the text after the icon
          const iconHTML = icon.outerHTML;
          element.innerHTML = iconHTML + ' ' + translation;
        } else {
          // No icon, just update the text
          element.textContent = translation;
        }
      } else {
        // For other elements (like span labels)
        const span = element.querySelector('span');
        const icon = element.querySelector('i');
        if (span && icon) {
          // Update only the span text, preserve the icon
          span.textContent = translation;
        } else if (icon) {
          const iconHTML = icon.outerHTML;
          element.innerHTML = iconHTML + ' ' + translation;
        } else {
          element.textContent = translation;
        }
      }
    });
    
    // Update specific UI elements that need special handling
    this.updateSpecificElements();
  }

  updateSpecificElements() {
    // Update button tooltips
    const startBtn = document.querySelector('#start');
    const stopBtn = document.querySelector('#stop');
    const restartBtn = document.querySelector('#restart');
    const rebuildBtn = document.querySelector('#rebuild');
    const updateBtn = document.querySelector('#update');
    
    if (startBtn) startBtn.setAttribute('title', this.t('ui.start'));
    if (stopBtn) stopBtn.setAttribute('title', this.t('ui.stop'));
    if (restartBtn) restartBtn.setAttribute('title', this.t('ui.restart'));
    if (rebuildBtn) rebuildBtn.setAttribute('title', this.t('ui.rebuild'));
    if (updateBtn) updateBtn.setAttribute('title', this.t('ui.update'));
  }
}

// Create global instance
const webUIi18n = new WebUIi18n();

// Function to get cookie value
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

// Initialize with saved language preference
document.addEventListener('DOMContentLoaded', () => {
  const savedLanguage = getCookie('ui-language');
  if (savedLanguage) {
    console.log('[WebUITranslations] Initializing with saved language:', savedLanguage);
    webUIi18n.setLanguage(savedLanguage);
  } else {
    console.log('[WebUITranslations] No saved language, using English');
    webUIi18n.setLanguage('en');
  }
});

// Listen for UI language changes from Electron
if (window.electronAPI) {
  window.electronAPI.onUILanguageChanged((event, data) => {
    if (data.language) {
      webUIi18n.setLanguage(data.language);
      // Also save to cookie for external browser
      document.cookie = `ui-language=${data.language}; path=/; max-age=31536000`;
    }
  });
}
