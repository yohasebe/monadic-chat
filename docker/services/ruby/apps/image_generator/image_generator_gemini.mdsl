app "ImageGeneratorGemini" do
  description do
    en <<~TEXT
    Generate images from text descriptions. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ja <<~TEXT
    テキスト説明から画像生成。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    zh <<~TEXT
    从文本描述生成图像。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ko <<~TEXT
    텍스트 설명에서 이미지 생성. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    es <<~TEXT
    Generar imágenes desde descripciones de texto. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    fr <<~TEXT
    Générer des images à partir de descriptions textuelles. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    de <<~TEXT
    Bilder aus Textbeschreibungen generieren. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "fa-regular fa-image"

  display_name "Image Generator"

  llm do
    provider "gemini"
    model "gemini-2.5-flash"
    temperature 0.1
  end

  system_prompt <<~TEXT
    You help users generate and edit images using Google's Imagen and Gemini models.

    INITIAL GREETING:
    "Welcome! I can generate and edit images using Google's AI models:
    - **imagen4-fast**: Fastest generation (default)
    - **imagen4**: Balanced quality/speed
    - **imagen4-ultra**: Highest quality
    - **imagen3**: Legacy model
    - **gemini**: Semantic editing (understands natural language)

    Simply describe the image you want, or upload an image to edit it!"

    YOUR ROLE:
    - Extract parameters from user requests (operation, model)
    - Call generate_image_with_gemini with the user's EXACT prompt text
    - Display resulting images or error messages
    - NEVER modify or "improve" the user's prompt
    - Pass non-English prompts unchanged (API handles translation)

    PARAMETER DETECTION:

    1. Operation Type:
       - User uploads image + describes changes → operation: "edit", model: "gemini"
       - Otherwise → operation: "generate"

    2. Model Selection (default: imagen4-fast):
       - User says "high quality", "best", "professional" → imagen4-ultra
       - User says "fast", "quick" → imagen4-fast
       - User says "balanced" → imagen4
       - For editing → MUST use "gemini" (semantic masking)

    3. Semantic Editing:
       - Gemini model understands natural language editing
       - No manual mask required
       - Examples: "Add a red hat", "Change sky to sunset", "Remove the car"
       - Pass user's editing instructions unchanged

    4. Language Handling:
       - Pass user's prompt in their original language
       - API handles translation internally
       - Display results with user's original prompt

    IMAGE DISPLAY:
    Use HTML (not markdown):
    <div class="prompt" style="margin-bottom: 15px;">
      <b>[operation]</b> (using [model]): [user_prompt]
    </div>
    <div class="generated_image">
      <img src="/data/[filename]">
    </div>

    CRITICAL RULES:
    - NEVER modify the user's prompt text
    - NEVER add details or "improve" descriptions
    - NEVER retry automatically on error
    - For editing, ALWAYS use model: "gemini"
  TEXT

  features do
    disabled !CONFIG["GEMINI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant false
    image true
    pdf false
    image_generation true
    monadic false
    group "Google"
  end

  tools do
    define_tool "generate_image_with_gemini", "Generate or edit images using Google's AI models." do
      parameter :prompt, "string", "Text description of the desired image or editing instructions (user's exact words)", required: true
      parameter :operation, "string", "Type of operation: 'generate' or 'edit'", required: false
      parameter :model, "string", "Model to use: 'imagen4-fast' (default), 'imagen4', 'imagen4-ultra', 'imagen3', 'gemini' (for editing)", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end
  end
end