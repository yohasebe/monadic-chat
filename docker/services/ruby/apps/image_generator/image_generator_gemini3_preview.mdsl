app "ImageGeneratorGemini3Preview" do
  description do
    en <<~TEXT
    Generate images directly with Gemini 3 Pro Image Preview (gemini-3-pro-image-preview).
    TEXT

    ja <<~TEXT
    Gemini 3 Pro Image Preview (gemini-3-pro-image-preview) を使って直接画像生成します。
    TEXT
  end

  icon "fa-regular fa-image"
  display_name "Gemini 3 Pro Image"

  system_prompt <<~TEXT
    You are a dedicated image generator/editor for Gemini 3 Pro Image Preview.

    CAPABILITIES:
    - Generate new images from text descriptions
    - Edit uploaded images using natural language instructions
    - Support up to 14 images for editing/conditioning

    YOUR ROLE:
    - Call generate_image_with_gemini3_preview exactly once per user request
    - Pass the user's prompt unchanged
    - Detect if user uploaded images (for editing) and pass session parameter
    - Extract aspect_ratio (16:9, 1:1, 4:5) and image_size (1K, 2K, 4K) if mentioned

    OPERATION DETECTION:
    - User uploads image(s) + describes changes → Image editing mode
    - Otherwise → Image generation mode
    - Both modes use the same tool with session parameter

    PARAMETER HANDLING:
    - prompt: User's exact words (required)
    - aspect_ratio: Extract if mentioned (e.g., "16:9", "square" → "1:1")
    - image_size: Extract if mentioned (e.g., "high quality" → "4K", "fast" → "1K")
    - session: Always pass (system provides automatically)

    IMAGE DISPLAY:
    After successful generation, return HTML (not markdown):
    <div class="prompt" style="margin-bottom: 15px;">
      <b>generate</b> (gemini-3-pro-image-preview): [user_prompt]
    </div>
    <div class="generated_image">
      <img src="/data/[filename]" style="max-width: 100%; border-radius: 8px; border: 1px solid #eee;">
    </div>

    CRITICAL RULES:
    - Call tool exactly ONCE per request
    - Do NOT call again if you see JSON result {"success":true,...} in history
    - Do NOT modify user's prompt
    - Do NOT ask follow-up questions
    - For errors, show concise error message
    - Never fall back to other models
  TEXT

  llm do
    provider "gemini"
    model "gemini-2.5-flash"
  end

  features do
    disabled !CONFIG["GEMINI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant false
    image_generation true
    monadic false
    group "Google"
  end

  tools do
    define_tool "generate_image_with_gemini3_preview", "Generate or edit images with Gemini 3 Pro Image Preview. For editing, uploaded images are automatically retrieved from session." do
      parameter :prompt, "string", "Text description of the desired image or editing instructions (user's exact words)", required: true
      parameter :aspect_ratio, "string", "Optional aspect ratio (e.g., 16:9, 1:1, 4:5)", required: false
      parameter :image_size, "string", "Optional resolution (1K, 2K, 4K)", required: false
      parameter :session, "object", "Session object (automatically provided, contains uploaded images)", required: false
    end
  end
end
