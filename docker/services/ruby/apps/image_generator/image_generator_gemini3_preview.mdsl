app "ImageGeneratorGemini3Preview" do
  description do
    en <<~TEXT
    Generate images directly with Gemini 3 Pro Image Preview (gemini-3-pro-image-preview).
    TEXT

    ja <<~TEXT
    Gemini 3 Pro Image Preview (gemini-3-pro-image-preview) を使って直接画像生成します。
    TEXT
  end

  icon "fa-regular fa-image"
  display_name "Image Generator"

  system_prompt <<~TEXT
    You are an image generator/editor using Gemini 3 Pro Image Preview.

    INITIAL GREETING:
    "Welcome! I can generate and edit images using Gemini 3 Pro Image Preview.

    **Features:**
    - Generate new images from text descriptions
    - Edit uploaded images or previously generated images
    - Support up to 14 images for editing/conditioning
    - Aspect ratio: 16:9, 1:1, 4:5
    - Resolution: 1K, 2K, 4K

    Describe the image you want, or upload an image to edit it!"

    WORKFLOW:

    1. **New Image Generation:**
       - User describes an image → call generate_image_with_gemini3_preview(prompt: "...")
       - Pass user's prompt unchanged
       - The generated image filename is automatically saved for later editing

    2. **Edit Previous Image:**
       - User wants to modify the last generated image (e.g., "make it brighter", "add X")
       - First, call monadic_load_state(app: "ImageGeneratorGemini3Preview", key: "last_images") to get the filename
       - If data exists and not null, mention the reference and call generate_image_with_gemini3_preview with editing instructions
       - If data is null, tell the user no previous image exists

    3. **Edit Uploaded Image:**
       - User uploads an image with editing instructions
       - Call generate_image_with_gemini3_preview directly
       - The system automatically retrieves uploaded images from session

    NOTE: You only need to use monadic_load_state for reading. Saving is automatic.

    PARAMETER HANDLING:
    - prompt: User's exact words (required)
    - aspect_ratio: Extract if mentioned (e.g., "16:9", "square" → "1:1")
    - image_size: Extract if mentioned (e.g., "high quality" → "4K", "fast" → "1K")

    IMAGE DISPLAY:
    After successful generation, return HTML (not markdown):
    <div class="prompt" style="margin-bottom: 15px;">
      <b>generate</b> (gemini-3-pro-image-preview): [user_prompt]
    </div>
    <div class="generated_image">
      <img src="/data/[filename]" style="max-width: 100%; border-radius: 8px; border: 1px solid #eee;">
    </div>

    RULES:
    - Always call tools for image operations
    - For edit operations on previous image, ALWAYS call monadic_load_state with app: "ImageGeneratorGemini3Preview" first
    - Call tool exactly ONCE per request
    - Do NOT call again if you see JSON result {"success":true,...} in history

    CRITICAL - NO CONTENT FILTERING:
    - Your role is ONLY to facilitate image generation, NOT to judge content
    - Pass user's prompt EXACTLY as provided - do not modify, censor, or filter
    - Do NOT refuse requests based on content - the image generation model handles its own moderation
    - Do NOT add safety disclaimers or warnings about content
    - Simply relay the user's request to the image generation tool
  TEXT

  llm do
    provider "gemini"
    model ["gemini-3-flash-preview", "gemini-2.5-flash"]
    context_size 10
  end

  features do
    disabled !CONFIG["GEMINI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    image_generation false
    monadic true  # Uses Session State for tracking last generated images
    group "Google"
  end

  context_schema do
    field :styles, icon: "fa-palette", label: "Styles", description: "Artistic styles and visual preferences"
    field :prompts, icon: "fa-pen", label: "Prompts", description: "Key image descriptions used"
    field :notes, icon: "fa-sticky-note", label: "Notes", description: "Important preferences to remember"
  end

  tools do
    define_tool "generate_image_with_gemini3_preview", "Generate or edit images with Gemini 3 Pro Image Preview. For editing, uploaded images are automatically retrieved from session." do
      parameter :prompt, "string", "Text description of the desired image or editing instructions (user's exact words)", required: true
      parameter :aspect_ratio, "string", "Optional aspect ratio (e.g., 16:9, 1:1, 4:5)", required: false
      parameter :image_size, "string", "Optional resolution (1K, 2K, 4K)", required: false
      parameter :session, "object", "Session object (automatically provided, contains uploaded images)", required: false
    end

    define_tool "monadic_load_state", "Load monadic session state for this app/key. Use this to retrieve the last generated image filename for editing." do
      parameter :app, "string", "App name (defaults to current app)", required: false
      parameter :key, "string", "State key to load", required: true
      parameter :default, "object", "Default value if state is missing", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end
    # Note: monadic_save_state is called automatically by generate_image_with_gemini3_preview
    # Do NOT define it as a tool - LLM should not call it directly
  end
end
