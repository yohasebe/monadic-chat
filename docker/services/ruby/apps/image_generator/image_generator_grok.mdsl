app "ImageGeneratorGrok" do
  description do
    en <<~TEXT
    Generate images from text descriptions. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ja <<~TEXT
    テキスト説明から画像生成。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    zh <<~TEXT
    从文本描述生成图像。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ko <<~TEXT
    텍스트 설명에서 이미지 생성. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    es <<~TEXT
    Generar imágenes desde descripciones de texto. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    fr <<~TEXT
    Générer des images à partir de descriptions textuelles. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    de <<~TEXT
    Bilder aus Textbeschreibungen generieren. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "fa-regular fa-image"

  display_name "Image Generator"

  llm do
    provider "xai"
    model "grok-4-1-fast-non-reasoning"
    temperature 0.0
    context_size 10
  end

  system_prompt <<~TEXT
    You are an image generator using xAI's Grok (powered by DALL-E 3).

    INITIAL GREETING:
    "Welcome! I can generate images from text descriptions using xAI's image generation.
    Simply describe what you'd like to see, and I'll create it for you!

    Note: While xAI's API doesn't support direct image editing, I can generate new images based on your descriptions that reference previous images."

    WORKFLOW:

    1. **New Image Generation:**
       - User describes an image → call generate_image_with_grok(prompt: "...")
       - Pass user's prompt unchanged
       - The generated image filename is automatically saved for later reference

    2. **Reference Previous Image:**
       - User wants a new image similar to or based on the last generated image
       - First, call monadic_load_state(app: "ImageGeneratorGrok", key: "last_images") to get the filename
       - If data exists and not null, mention the filename in your response and generate a new image based on the user's description
       - If data is null, tell the user no previous image exists

    NOTE: You only need to use monadic_load_state for reading. Saving is automatic.

    RESULT DISPLAY:
    Success (success=true with filename):
    <div class="prompt" style="margin-bottom: 15px;">
      <b>Revised Prompt</b>: [revised_prompt from API]
    </div>
    <div class="generated_image">
      <img src="/data/[filename]">
    </div>

    Error (success=false):
    Display the error message without additional commentary

    RULES:
    - Always call tools for image operations
    - Do not modify user's prompt
    - For referencing previous image, ALWAYS call monadic_load_state with app: "ImageGeneratorGrok" first
    - NEVER retry automatically on error
  TEXT

  features do
    disabled !CONFIG["XAI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    image_generation false
    monadic true  # Uses Session State for tracking last generated images
    group "xAI"
  end

  context_schema do
    field :styles, icon: "fa-palette", label: "Styles", description: "Artistic styles and visual preferences"
    field :prompts, icon: "fa-pen", label: "Prompts", description: "Key image descriptions used"
    field :notes, icon: "fa-sticky-note", label: "Notes", description: "Important preferences to remember"
  end

  tools do
    define_tool "generate_image_with_grok", "Generate images using Dall-E 3 through xAI Grok." do
      parameter :prompt, "string", "Text description of the desired image", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "monadic_load_state", "Load monadic session state for this app/key. Use this to retrieve the last generated image filename for reference." do
      parameter :app, "string", "App name (defaults to current app)", required: false
      parameter :key, "string", "State key to load", required: true
      parameter :default, "object", "Default value if state is missing", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end
    # Note: monadic_save_state is called automatically by generate_image_with_grok
    # Do NOT define it as a tool - LLM should not call it directly
  end
end
