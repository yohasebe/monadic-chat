app "ImageGeneratorGrok" do
  description do
    en <<~TEXT
    Generate images from text descriptions. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ja <<~TEXT
    テキスト説明から画像生成。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    zh <<~TEXT
    从文本描述生成图像。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ko <<~TEXT
    텍스트 설명에서 이미지 생성. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    es <<~TEXT
    Generar imágenes desde descripciones de texto. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    fr <<~TEXT
    Générer des images à partir de descriptions textuelles. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    de <<~TEXT
    Bilder aus Textbeschreibungen generieren. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "fa-regular fa-image"

  display_name "Image Generator"

  llm do
    provider "xai"
    model "grok-4-fast-non-reasoning"
    temperature 0.0
  end

  system_prompt <<~TEXT
    You help users generate images using xAI's image generation (powered by DALL-E 3).

    INITIAL GREETING:
    "Welcome! I can generate images from text descriptions using xAI's image generation.
    Simply describe what you'd like to see, and I'll create it for you!"

    YOUR ROLE:
    - Call generate_image_with_grok with the user's EXACT prompt text
    - Display resulting images or error messages
    - NEVER modify or "improve" the user's prompt
    - API handles content filtering; do not pre-judge requests

    PROCESS:
    1. Call generate_image_with_grok({ prompt: [user's exact prompt] })
    2. Check response success field
    3. Display result

    RESPONSE HANDLING:
    Success (success=true with filename):
    <div class="prompt" style="margin-bottom: 15px;">
      <b>Revised Prompt</b>: [revised_prompt from API]
    </div>
    <div class="generated_image">
      <img src="/data/[filename]">
    </div>

    Error (success=false):
    Display the error message without additional commentary

    IMAGE MODIFICATION:
    - To modify an image, call generate_image_with_grok again with an extended prompt
    - Do not attempt to edit images directly
    - Each call generates a new image

    CRITICAL RULES:
    - NEVER modify the user's prompt text
    - NEVER retry automatically on error
    - If repeated function calls occur without results, inform user to start a new conversation
  TEXT

  features do
    disabled !CONFIG["XAI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    image_generation true
    monadic false
    group "xAI"
  end

  tools do
    define_tool "generate_image_with_grok", "Generate images using Dall-E 3 through xAI Grok." do
      parameter :prompt, "string", "Text description of the desired image", required: true
    end

    # Auto-generated tool definitions
    define_tool "generate_image_with_openai", "Generate Image With Openai" do
      parameter :operation, "string", "The operation", required: true
      parameter :model, "string", "The model", required: true
      parameter :prompt, "string", "The prompt"
      parameter :images, "string", "The images"
      parameter :mask, "string", "The mask"
      parameter :n, "integer", "The n"
      parameter :size, "string", "The size"
      parameter :quality, "string", "The quality"
      parameter :output_format, "string", "The output format"
      parameter :background, "string", "The background"
      parameter :output_compression, "string", "The output compression"
    end

    define_tool "generate_image_with_gemini", "Generate Image With Gemini" do
      parameter :model, "string", "The model", required: true
      parameter :prompt, "string", "The prompt", required: true
      parameter :n, "integer", "The n"
      parameter :size, "string", "The size"
      parameter :output_format, "string", "The output format"
    end
  end
end
