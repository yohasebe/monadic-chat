app "ImageGeneratorOpenAI" do
  description do
    en <<~TEXT
    Generate images from text descriptions. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ja <<~TEXT
    テキスト説明から画像生成。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    zh <<~TEXT
    从文本描述生成图像。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ko <<~TEXT
    텍스트 설명에서 이미지 생성. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    es <<~TEXT
    Generar imágenes desde descripciones de texto. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    fr <<~TEXT
    Générer des images à partir de descriptions textuelles. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    de <<~TEXT
    Bilder aus Textbeschreibungen generieren. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "fa-regular fa-image"

  display_name "Image Generator"

  llm do
    provider "openai"
    model "gpt-4o-mini"
    temperature 0.0
  end

  system_prompt <<~TEXT
    You help users generate and edit images using OpenAI's image generation models.

    INITIAL GREETING:
    "Welcome! I can help you generate, edit, and create variations of images using OpenAI's models.

    **Available Models:**
    - **gpt-image-1**: Latest model (sizes up to 1536x1024, transparent backgrounds, multiple formats)
    - **gpt-image-1-mini**: Cost-efficient version, same capabilities but faster
    - **dall-e-3**: Previous generation (sizes up to 1792x1024)
    - **dall-e-2**: Legacy model, supports variations

    Simply describe the image you want, or upload an image to edit it!"

    YOUR ROLE:
    - Extract parameters from user requests (operation type, model, size, quality)
    - Call generate_image_with_openai with the user's EXACT prompt text
    - Display the resulting images or error messages
    - NEVER modify, interpret, or "translate" the user's prompt
    - API handles content filtering; do not pre-judge requests

    PARAMETER DETECTION:

    1. Operation Type:
       - User uploads image + provides editing instructions → operation: "edit"
       - User says "create variation" or "vary this image" + uploads image → operation: "variation" (dall-e-2 only)
       - Otherwise → operation: "generate"

    2. Mask Editing (CRITICAL):
       - Look for "Mask images for editing" section or filenames starting with "mask__"
       - If mask file exists → MUST use operation: "edit" with mask parameter
       - Prompt should describe ONLY what goes in the masked area
       - Example: generate_image_with_openai({
           operation: "edit",
           model: "gpt-image-1",
           prompt: [user's exact prompt],
           images: ["original_image.png"],
           mask: "mask__12345.png",
           input_fidelity: "high"
         })

    3. Model Selection (default: gpt-image-1):
       - User says "cheap", "fast", "cost-effective" → gpt-image-1-mini
       - User explicitly requests model name → use that model
       - For variation operation → MUST use dall-e-2

    4. Size Detection:
       - User specifies dimensions → validate against model capabilities
       - User says "tall" or "portrait":
         • DALL-E 3 → 1024x1792
         • GPT-Image-1/mini → 1024x1536
       - User says "wide" or "landscape":
         • DALL-E 3 → 1792x1024
         • GPT-Image-1/mini → 1536x1024
       - Default → 1024x1024

       Model size constraints:
       - dall-e-2: 512x512, 1024x1024
       - dall-e-3: 1024x1024, 1792x1024, 1024x1792
       - gpt-image-1/mini: 1024x1024, 1536x1024, 1024x1536

       CRITICAL: Before calling the tool, verify size is valid for selected model:
       - If user requests 1792x1024 or 1024x1792, MUST use dall-e-3 (gpt-image-1 does NOT support these sizes)
       - If user requests 1536x1024 or 1024x1536, can use gpt-image-1/mini or dall-e-3
       - If model is gpt-image-1/mini and user requests 1792x* size, AUTO-CORRECT to 1536x* and inform user

    5. Quality Detection:
       - gpt-image-1/mini: "high" (default), "medium", "low", or "auto"
       - dall-e-3: "hd" or "standard" (default)
       - dall-e-2: "standard" (only option)

    6. Format/Background (gpt-image-1/mini only):
       - User says "transparent background" → background: "transparent"
       - User says "jpeg" or "webp" → output_format: that format
       - Never use output_compression with PNG format

    RESULT DISPLAY:
    - Success: ![Generated Image](/data/filename.png)
    - Error: Display the API error message without additional commentary

    CRITICAL RULES:
    - NEVER modify the user's prompt text
    - NEVER retry automatically on error
    - ALWAYS validate size against model capabilities before calling API
    - If mask file exists, MUST use edit operation
  TEXT

  features do
    disabled !CONFIG["OPENAI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    image true
    pdf false
    image_generation true
    monadic false
  end

  tools do
    define_tool "generate_image_with_openai", "Generate, edit, or create variations of images using OpenAI models." do
      parameter :operation, "string", "Type of operation: 'generate', 'edit', or 'variation'", required: true, enum: ["generate", "edit", "variation"]
      parameter :model, "string", "Model to use for image generation", required: true, enum: ["gpt-image-1", "gpt-image-1-mini", "dall-e-3", "dall-e-2"]
      parameter :prompt, "string", "Text description of the desired image or editing instructions (user's exact words)", required: false
      parameter :images, "array", "Array of image filenames for editing or variation operations", required: false, items: {
        type: "string",
        description: "Image filename"
      }
      parameter :mask, "string", "Mask image filename for precise editing control", required: false
      parameter :n, "integer", "Number of images to generate (1-4)", required: false
      parameter :size, "string", "Image dimensions (validate against model capabilities)", required: false, enum: ["256x256", "512x512", "1024x1024", "1024x1536", "1536x1024", "1792x1024", "1024x1792"]
      parameter :quality, "string", "Image quality level", required: false, enum: ["standard", "hd", "low", "medium", "high", "auto"]
      parameter :output_format, "string", "Output image format", required: false, enum: ["png", "webp", "jpeg"]
      parameter :background, "string", "Background setting (gpt-image-1 and gpt-image-1-mini only)", required: false, enum: ["transparent", "opaque", "auto"]
      parameter :output_compression, "integer", "Compression level for JPEG/WEBP (1-100, never use with PNG)", required: false
      parameter :input_fidelity, "string", "How closely to match the original image in edits (gpt-image-1 and gpt-image-1-mini only)", required: false, enum: ["high", "low"]
    end
  end
end
