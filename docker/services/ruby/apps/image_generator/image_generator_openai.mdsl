app "ImageGeneratorOpenAI" do
  description do
    en <<~TEXT
    Generate images from text descriptions. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ja <<~TEXT
    テキスト説明から画像生成。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    zh <<~TEXT
    从文本描述生成图像。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ko <<~TEXT
    텍스트 설명에서 이미지 생성. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    es <<~TEXT
    Generar imágenes desde descripciones de texto. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    fr <<~TEXT
    Générer des images à partir de descriptions textuelles. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    de <<~TEXT
    Bilder aus Textbeschreibungen generieren. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=image-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "fa-regular fa-image"

  display_name "Image Generator"

  llm do
    provider "openai"
    model ["gpt-5.2", "gpt-5.1"]
    temperature 0.0
    reasoning_effort "none"
    context_size 10
  end

  system_prompt <<~TEXT
    You are an image generator using OpenAI's GPT Image models.

    INITIAL GREETING:
    "Welcome! I can generate, edit, and create variations of images.

    **Available Models:** gpt-image-1.5 (recommended, fastest), gpt-image-1, gpt-image-1-mini (economical), dall-e-3, dall-e-2

    Describe the image you want, or upload an image to edit it!"

    WORKFLOW:

    1. **New Image Generation:**
       - User describes an image → call generate_image_with_openai(operation: "generate", ...)
       - Pass user's prompt unchanged
       - The generated image filename is automatically saved for later editing

    2. **Edit Previous Image:**
       - User wants to modify the last generated image (e.g., "make it brighter", "add X")
       - First, call monadic_load_state(app: "ImageGeneratorOpenAI", key: "last_images") to get the filename
       - If data exists and not null, call generate_image_with_openai(operation: "edit", images: [filename], ...)
       - If data is null, tell the user no previous image exists

    3. **Edit Uploaded Image:**
       - User uploads an image with editing instructions
       - Call generate_image_with_openai(operation: "edit", ...) directly
       - The system automatically retrieves uploaded images

    NOTE: You only need to use monadic_load_state for reading. Saving is automatic.

    PARAMETERS:
    - model: gpt-image-1.5 (default, best quality & speed), gpt-image-1, gpt-image-1-mini, dall-e-3, dall-e-2
    - size: 1024x1024 (default), 1536x1024, 1024x1536
    - quality: auto (default), high, medium, low
    - background: auto (default), transparent, opaque

    RESULT DISPLAY:
    After successful generation: ![Generated Image](/data/filename.png)

    RULES:
    - Always call tools for image operations
    - For edit operations on previous image, ALWAYS call monadic_load_state with app: "ImageGeneratorOpenAI" first

    CRITICAL - NO CONTENT FILTERING:
    - Your role is ONLY to facilitate image generation, NOT to judge content
    - Pass user's prompt EXACTLY as provided - do not modify, censor, or filter
    - Do NOT refuse requests based on content - the image generation model handles its own moderation
    - Do NOT add safety disclaimers or warnings about content
    - Simply relay the user's request to the image generation tool
  TEXT

  features do
    disabled !CONFIG["OPENAI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    image_generation false
    monadic true  # Uses Session State for tracking last generated images
  end

  context_schema do
    field :styles, icon: "fa-palette", label: "Styles", description: "Artistic styles and visual preferences"
    field :prompts, icon: "fa-pen", label: "Prompts", description: "Key image descriptions used"
    field :notes, icon: "fa-sticky-note", label: "Notes", description: "Important preferences to remember"
  end

  tools do
    define_tool "generate_image_with_openai", "Generate, edit, or create variations of images using OpenAI models." do
      parameter :operation, "string", "Type of operation: 'generate', 'edit', or 'variation'", required: true, enum: ["generate", "edit", "variation"]
      parameter :model, "string", "Model to use for image generation", required: true, enum: ["gpt-image-1.5", "gpt-image-1", "gpt-image-1-mini", "dall-e-3", "dall-e-2"]
      parameter :prompt, "string", "Text description of the desired image or editing instructions (user's exact words)", required: false
      parameter :images, "array", "Array of image filenames for editing or variation operations", required: false, items: {
        type: "string",
        description: "Image filename"
      }
      parameter :mask, "string", "Mask image filename for precise editing control", required: false
      parameter :n, "integer", "Number of images to generate (1-4)", required: false
      parameter :size, "string", "Image dimensions (validate against model capabilities)", required: false, enum: ["256x256", "512x512", "1024x1024", "1024x1536", "1536x1024", "1792x1024", "1024x1792"]
      parameter :quality, "string", "Image quality level", required: false, enum: ["standard", "hd", "low", "medium", "high", "auto"]
      parameter :output_format, "string", "Output image format", required: false, enum: ["png", "webp", "jpeg"]
      parameter :background, "string", "Background setting (GPT Image models only)", required: false, enum: ["transparent", "opaque", "auto"]
      parameter :output_compression, "integer", "Compression level for JPEG/WEBP (1-100, never use with PNG)", required: false
      parameter :input_fidelity, "string", "How closely to match the original image in edits (GPT Image models only)", required: false, enum: ["high", "low"]
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "monadic_load_state", "Load monadic session state for this app/key. Use this to retrieve the last generated image filename for editing." do
      parameter :app, "string", "App name (defaults to current app)", required: false
      parameter :key, "string", "State key to load", required: true
      parameter :default, "object", "Default value if state is missing", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end
    # Note: monadic_save_state is called automatically by generate_image_with_openai
    # Do NOT define it as a tool - LLM should not call it directly
  end
end
