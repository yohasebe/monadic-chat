app "JupyterNotebookGrok" do
  description do
    en <<~TEXT
    Create and manage Jupyter notebooks with code execution. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=jupyter-notebook" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ja <<~TEXT
    コード実行可能なJupyterノートブックの作成と管理。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=jupyter-notebook" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    zh <<~TEXT
    创建和管理可执行代码的Jupyter笔记本。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=jupyter-notebook" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    ko <<~TEXT
    코드 실행이 가능한 Jupyter 노트북 생성 및 관리. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=jupyter-notebook" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    es <<~TEXT
    Crear y gestionar notebooks Jupyter con ejecución de código. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=jupyter-notebook" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    fr <<~TEXT
    Créer et gérer des notebooks Jupyter avec exécution de code. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=jupyter-notebook" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
    
    de <<~TEXT
    Jupyter-Notebooks mit Code-Ausführung erstellen und verwalten. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=jupyter-notebook" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end
  
  icon "rocket"
  display_name "Jupyter Notebook"
  
  llm do
    provider "xai"
    model "grok-4-fast-reasoning"
    temperature 0.0
    max_tokens 4096
    tool_choice "auto"  # Let Grok decide when to use tools
    parallel_function_calling true  # Explicitly enable parallel function calling (default)

    agents do
      code_generator model: "grok-code-fast-1"
    end
  end

  system_prompt <<~TEXT
    You are a Jupyter Notebook assistant. When users ask you to create notebooks or add cells, use the available tools.

    ## CRITICAL: Use the Combined Tool for New Notebooks
    
    When creating a NEW notebook, simply use:
    - `create_and_populate_jupyter_notebook` - This creates the notebook AND adds all cells in ONE operation
    
    Note: You can call both `run_jupyter` and `create_and_populate_jupyter_notebook` in the same response (parallel function calling is enabled)
    
    The `create_and_populate_jupyter_notebook` tool:
    - Creates a new notebook with the given filename
    - Automatically adds a timestamp to the filename
    - Adds all the cells you specify
    - Returns the actual filename with timestamp
    - Use this instead of separate create_jupyter_notebook + add_jupyter_cells calls
    
    Example cells array for the combined tool:
    ```json
    [
      {"cell_type": "code", "source": "import numpy as np\\nimport matplotlib.pyplot as plt"},
      {"cell_type": "markdown", "source": "# Data Analysis"},
      {"cell_type": "code", "source": "x = np.linspace(0, 10, 100)\\ny = np.sin(x)"}
    ]
    ```
    
    ## For Existing Notebooks

    Use these tools for working with existing notebooks:
    - `add_jupyter_cells` - Add more cells to an existing notebook
    - `update_jupyter_cell` - Modify a specific cell
    - `delete_jupyter_cell` - Remove a cell
    - `get_jupyter_cells_with_results` - View notebook contents

    ## Error Handling

    AUTOMATIC ERROR DETECTION (BUILT-IN):
    add_jupyter_cells(run: true) AUTOMATICALLY verifies execution and reports errors.

    Response format:
    - SUCCESS: "✓ All N cells executed successfully without errors."
    - ERRORS: "⚠️  ERRORS DETECTED IN NOTEBOOK:" with cell index, error type, error message

    When you see "⚠️  ERRORS DETECTED":
    1. Read the error summary
    2. Use get_jupyter_cells_with_results(filename) for full traceback if needed
    3. Apply fixes based on error patterns (see below)
    4. Use update_jupyter_cell(filename:, index:, content:) to fix
    5. Re-run and verify (max 2 retries)

    Common Error Patterns:
    - NameError: name 'matplotlib' is not defined → Add "import matplotlib" to imports cell
    - ModuleNotFoundError → Add "!pip install xxx" cell before imports
    - AttributeError with matplotlib.cm.get_cmap → Replace with matplotlib.colormaps['name']
    - SyntaxError → Check string escaping and LaTeX formatting

    IMPORTANT: No need to manually call get_jupyter_cells_with_results after add_jupyter_cells.
    Maximum 2 retry attempts for error fixes to prevent infinite loops.

    ## Session Management
    
    - The tools will return the actual notebook filename with timestamp (e.g., notebook_20250828_143025.ipynb)
    - ALWAYS use the EXACT filename returned by the tool in your response
    - DO NOT use placeholder timestamps like 123456 or example dates
    - Remember the notebook filename for the entire conversation
    - DO NOT mention technical details like "The last cell output is..." - just confirm the operation succeeded
    
    For matplotlib plots, Japanese fonts are pre-configured (Noto Sans CJK JP).
    
    CRITICAL: When providing notebook links, use the ACTUAL filename returned by the tool:
    - CORRECT: <a href='http://localhost:8889/lab/tree/actual_notebook_20250828_143025.ipynb' target='_blank'>actual_notebook_20250828_143025.ipynb</a>
    - WRONG: <a href='http://localhost:8889/lab/tree/notebook_20231001_123456.ipynb' target='_blank'>notebook_20231001_123456.ipynb</a>
  TEXT

  features do
    disabled !CONFIG["XAI_API_KEY"]
    easy_submit false
    auto_speech false
    image true
    pdf false
    monadic false
    jupyter true
    mathjax true
    initiate_from_assistant true
  end

  tools do
    # Import shared Jupyter operations tools (always visible - Phase 1)
    import_shared_tools :jupyter_operations, visibility: "always"

    # Import shared Python execution tools (always visible - Phase 1)
    import_shared_tools :python_execution, visibility: "always"

    # Import shared file operations tools (always visible - Phase 1)
    import_shared_tools :file_operations, visibility: "always"

    # Import shared file reading tools (always visible - Phase 1)
    import_shared_tools :file_reading, visibility: "always"

    # COMBINED TOOL FOR xAI GROK - Optimal for parallel function calling
    # This creates the notebook AND adds cells in ONE operation
    define_tool "create_and_populate_jupyter_notebook", "Create a new Jupyter notebook AND add cells in one operation (USE THIS FOR CREATING NEW NOTEBOOKS)" do
      parameter :filename, "string", "Base filename for the notebook", required: true
      parameter :cells, "array", "Array of cell objects to add", required: true, items: { "type" => "object" }
      parameter :run, "boolean", "Whether to run the cells after adding", required: false
    end

    # Grok-Code agent for complex code generation
    define_tool "grok_code_agent", "Call Grok-Code-Fast-1 agent for complex notebook code generation" do
      parameter :task, "string", "Description of the code generation task", required: true
      parameter :notebook_context, "string", "Context about the current notebook state", required: false
      parameter :cell_content, "string", "Existing cell content to modify or reference", required: false
    end
  end
end