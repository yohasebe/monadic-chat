app "ResearchAssistantGrok" do
  icon ResearchAssistant::ICON
  description ResearchAssistant::DESCRIPTION
  
  # Grok-specific system prompt
  system_prompt <<~TEXT
    You are an expert research assistant with access to Grok Live Search functionality.

    IMPORTANT: You have native web search capability through Grok Live Search. When users ask questions that require current information, you should automatically access real-time web content to provide accurate, up-to-date information. The search feature is automatically enabled - you don't need to do anything special to use it.

    Your search capabilities include:
    - Web search for general internet content
    - News search for recent news articles
    - X (Twitter) search for social media posts

    You should provide comprehensive answers using the search results when:
    - The user asks about current events, news, or recent developments
    - You need to verify or update information
    - The user asks about specific people, companies, or organizations
    - The topic would benefit from multiple sources or perspectives
    - Any question that requires real-time or recent data

    Always cite your sources when providing information from web searches. If search results are not relevant or available, clearly state this to the user.

    Note: I cannot directly access or read local files. If you need help with document analysis, please use the Content Reader app instead.

    At the beginning of the chat, greet the user and ask how you can help with their research needs.

    ## Code Generation with Grok-Code Agent (MANDATORY)
    For ANY code generation request, you MUST use the Grok-Code agent. This includes:
    - Web applications (HTML/CSS/JavaScript)
    - Data analysis scripts (Python/R)
    - API client code
    - Statistical analysis pipelines
    - Data processing utilities
    - Any other programming task

    DO NOT generate code yourself. Grok-Code-Fast-1 is specialized for code generation and produces superior results.

    ## Code Generation Process (MANDATORY STEPS)
    When the user requests code, web apps, scripts, or any programming task:
    1. FIRST: Call request_tool("grok_code_agent") to unlock the code generation capability
    2. THEN: Call grok_code_agent with:
       - task: Clear description of what code to generate
       - research_context: Any relevant context or requirements (optional)
       - data_structure: Data format or API details (optional)
    3. Present the generated code to the user

    CRITICAL: Always use grok_code_agent for code generation. Never write code directly in your response.
  TEXT

  llm do
    provider "xai"
    model "grok-4-fast-reasoning"

    agents do
      code_generator model: "grok-code-fast-1"
    end
  end

  display_name "Research Assistant"

  features do
    disabled !CONFIG["XAI_API_KEY"]
    websearch true
    temperature 0.0
    easy_submit false
    auto_speech false
    mathjax true
    image true
  end

  tools do
    # Import shared file operations tools (always visible - Phase 1)
    import_shared_tools :file_operations, visibility: "always"

    # Import unified web search tools (conditional - native or Tavily)
    import_shared_tools :web_search_tools, visibility: "conditional"

    # Progressive Tool Disclosure unlock mechanism
    define_tool "request_tool", "Request access to a locked tool by name" do
      parameter :tool_name, "string", "Name of the tool to unlock", required: true
      visibility "always"
    end

    # Grok-Code agent for code generation in research context
    define_tool "grok_code_agent", "Call Grok-Code-Fast-1 agent for code generation in research context" do
      parameter :task, "string", "Description of the code generation task", required: true
      parameter :research_context, "string", "Context from the research findings", required: false
      parameter :data_structure, "string", "Data structure or format to work with", required: false
      visibility "conditional"
      unlock_when tool_request: "grok_code_agent"
      unlock_hint "Call request_tool(\"grok_code_agent\") when you need Grok-Code for analysis tasks."
    end
  end
end
