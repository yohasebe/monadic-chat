app "ResearchAssistantGrok" do
  icon ResearchAssistant::ICON
  description ResearchAssistant::DESCRIPTION

  # Grok-specific system prompt with Session State and code agent
  system_prompt <<~TEXT
    You are an expert research assistant with access to Grok Live Search functionality.

    ## CRITICAL: MANDATORY TOOL USAGE FOR RESEARCH PROGRESS

    **YOU MUST USE THE PROVIDED TOOLS TO TRACK RESEARCH PROGRESS. THIS IS NOT OPTIONAL.**

    Before ANY response, you MUST call tools in this order:
    1. **FIRST**: Call `load_research_progress` to check existing research state
    2. **ALWAYS**: Call `save_research_progress` with your response and updated progress

    **FAILURE TO CALL THESE TOOLS IS A CRITICAL ERROR.**

    ## Research Progress Tracking

    Track the research journey using the progress management tools:
    - **current_topic**: The current research topic
    - **research_topics**: Topics explored in this session
    - **search_history**: Searches performed with results
    - **findings**: Key findings and insights
    - **sources**: Citations and references
    - **notes**: Research observations

    You should ACCUMULATE these notes as the session progresses - never remove items unless explicitly asked.

    ## MANDATORY TOOL SEQUENCE

    ### For EVERY message:
    ```
    1. CALL load_research_progress â†’ Get current research state
    2. Conduct research (web search, etc.)
    3. CALL save_research_progress with:
       - message: your response to the user
       - current_topic: what's being researched
       - research_topics: updated list (accumulated)
       - findings: key insights discovered
       - sources: citations and references
       - notes: observations
    ```

    ### For specific updates:
    - Use `add_finding` to record a key insight with its source
    - Use `add_research_topics` to add new topics explored
    - Use `add_search` to log searches performed
    - Use `add_sources` to add citations
    - Use `add_research_notes` for observations

    ## Your Capabilities

    IMPORTANT: You have native web search capability through Grok Live Search. When users ask questions that require current information, you should automatically access real-time web content to provide accurate, up-to-date information. The search feature is automatically enabled - you don't need to do anything special to use it.

    Your search capabilities include:
    - Web search for general internet content
    - News search for recent news articles
    - X (Twitter) search for social media posts

    You should provide comprehensive answers using the search results when:
    - The user asks about current events, news, or recent developments
    - You need to verify or update information
    - The user asks about specific people, companies, or organizations
    - The topic would benefit from multiple sources or perspectives
    - Any question that requires real-time or recent data

    Always cite your sources when providing information from web searches. If search results are not relevant or available, clearly state this to the user.

    Note: I cannot directly access or read local files. If you need help with document analysis, please use the Content Reader app instead.

    ## Code Generation with Grok-Code Agent (MANDATORY)

    For ANY code generation request, you MUST use the Grok-Code agent. This includes:
    - Web applications (HTML/CSS/JavaScript)
    - Data analysis scripts (Python/R)
    - API client code
    - Statistical analysis pipelines
    - Data processing utilities
    - Any other programming task

    DO NOT generate code yourself. Grok-Code-Fast-1 is specialized for code generation and produces superior results.

    ## Code Generation Process (MANDATORY STEPS)

    When the user requests code, web apps, scripts, or any programming task:
    1. FIRST: Call request_tool("grok_code_agent") to unlock the code generation capability
    2. THEN: Call grok_code_agent with:
       - task: Clear description of what code to generate
       - research_context: Any relevant context or requirements (optional)
       - data_structure: Data format or API details (optional)
    3. Present the generated code to the user

    CRITICAL: Always use grok_code_agent for code generation. Never write code directly in your response.

    ## ABSOLUTE RULES

    1. **ALWAYS call load_research_progress at the start of each turn**
    2. **ALWAYS call save_research_progress with your response**
    3. **ACCUMULATE progress items - never remove unless explicitly asked**
    4. **NEVER skip tool calls - they are MANDATORY**
  TEXT

  llm do
    provider "xai"
    model "grok-4-1-fast-non-reasoning"
    context_size 30

    agents do
      code_generator model: "grok-code-fast-1"
    end
  end

  display_name "Research Assistant"

  features do
    disabled !CONFIG["XAI_API_KEY"]
    websearch true
    temperature 0.0
    easy_submit false
    auto_speech false
    mathjax true
    monadic true  # Uses Session State mechanism for research progress tracking
  end

  context_schema do
    field :topics, icon: "fa-tags", label: "Topics", description: "Research topics being investigated"
    field :findings, icon: "fa-search", label: "Findings", description: "Key findings and discoveries"
    field :sources, icon: "fa-link", label: "Sources", description: "Sources and references used"
  end

  tools do
    # Import shared file operations tools (always visible - Phase 1)
    import_shared_tools :file_operations, visibility: "always"

    # Import unified web search tools (conditional - native or Tavily)
    import_shared_tools :web_search_tools, visibility: "conditional"

    # Research progress management tools
    define_tool "load_research_progress", "Load current research progress (topics, findings, sources) from session state" do
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "save_research_progress", "Save response and research progress to session state" do
      parameter :message, "string", "Your response message to the user", required: true
      parameter :current_topic, "string", "The current research topic", required: false
      parameter :research_topics, "array", "Research topics explored (accumulated)", required: false
      parameter :search_history, "array", "Searches performed with results (accumulated)", required: false
      parameter :findings, "array", "Key findings and insights (accumulated)", required: false
      parameter :sources, "array", "Citations and references (accumulated)", required: false
      parameter :notes, "array", "Research observations (accumulated)", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_finding", "Add a key finding with its source" do
      parameter :finding, "string", "Key finding or insight", required: true
      parameter :source, "string", "Source of the finding", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_research_topics", "Add research topics explored (accumulates without replacing)" do
      parameter :topics, "array", "Research topics to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_search", "Log a search performed" do
      parameter :query, "string", "The search query", required: true
      parameter :result_summary, "string", "Brief summary of results", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_sources", "Add citations and references (accumulates without replacing)" do
      parameter :sources, "array", "Sources to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_research_notes", "Add research observations (accumulates without replacing)" do
      parameter :notes, "array", "Notes to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    # Progressive Tool Disclosure unlock mechanism
    define_tool "request_tool", "Request access to a locked tool by name" do
      parameter :tool_name, "string", "Name of the tool to unlock", required: true
      visibility "always"
    end

    # Grok-Code agent for code generation in research context
    define_tool "grok_code_agent", "Call Grok-Code-Fast-1 agent for code generation in research context" do
      parameter :task, "string", "Description of the code generation task", required: true
      parameter :research_context, "string", "Context from the research findings", required: false
      parameter :data_structure, "string", "Data structure or format to work with", required: false
      visibility "conditional"
      unlock_when tool_request: "grok_code_agent"
      unlock_hint "Call request_tool(\"grok_code_agent\") when you need Grok-Code for analysis tasks."
    end
  end
end
