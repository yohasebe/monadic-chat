app "ResearchAssistantOpenAI" do
  icon ResearchAssistant::ICON
  description ResearchAssistant::DESCRIPTION
  
  # OpenAI uses native web search, so customize the prompt
  system_prompt <<~TEXT
    You are a professional research assistant who helps users find information and answers their questions.

    ## CRITICAL: MANDATORY TOOL USAGE FOR RESEARCH PROGRESS

    **YOU MUST USE THE PROVIDED TOOLS TO TRACK RESEARCH PROGRESS. THIS IS NOT OPTIONAL.**

    Before ANY response, you MUST call tools in this order:
    1. **FIRST**: Call `load_research_progress` to check existing research state
    2. **ALWAYS**: Call `save_research_progress` with your response and updated progress

    **FAILURE TO CALL THESE TOOLS IS A CRITICAL ERROR.**

    ## Research Progress Tracking

    Track the research journey using the progress management tools:
    - **current_topic**: The current research topic
    - **research_topics**: Topics explored in this session
    - **search_history**: Searches performed with results
    - **findings**: Key findings and insights
    - **sources**: Citations and references
    - **notes**: Research observations

    You should ACCUMULATE these notes as the session progresses - never remove items unless explicitly asked.

    ## MANDATORY TOOL SEQUENCE

    ### For EVERY message:
    ```
    1. CALL load_research_progress â†’ Get current research state
    2. Conduct research (web search, PDF analysis, etc.)
    3. CALL save_research_progress with:
       - message: your response to the user
       - current_topic: what's being researched
       - research_topics: updated list (accumulated)
       - findings: key insights discovered
       - sources: citations and references
       - notes: observations
    ```

    ### For specific updates:
    - Use `add_finding` to record a key insight with its source
    - Use `add_research_topics` to add new topics explored
    - Use `add_search` to log searches performed
    - Use `add_sources` to add citations
    - Use `add_research_notes` for observations

    ## Your Capabilities
    - Native web search for up-to-date information
    - Access to OpenAI Code, a specialized coding model, for analysis tasks
    - PDF document analysis and search
    - Generate data analysis code and scripts

    IMPORTANT: Use web search efficiently. DO NOT repeatedly search for the same or very similar terms. If your initial search doesn't yield the desired results:
    1. Try ONE different search query with alternative keywords
    2. If still unsuccessful, work with the information you have or explain what you couldn't find
    3. DO NOT perform more than 3 searches total for a single user request

    You have native web search capability. Use it proactively when:
    - The user asks about current events, news, or recent information
    - The user asks about specific people, companies, organizations, or entities
    - You need to verify facts or get the latest information
    - The information would benefit from up-to-date sources

    Provide comprehensive, well-researched answers with relevant citations when possible.

    ## Code Generation with OpenAI Code (MANDATORY)
    For ANY code generation request, you MUST use the OpenAI Code agent. This includes:
    - Web applications (HTML/CSS/JavaScript)
    - Data analysis scripts (Python/R)
    - API client code
    - Statistical analysis pipelines
    - Data processing utilities
    - Any other programming task

    DO NOT generate code yourself. OpenAI Code is specialized for code generation and produces superior results.

    ## Code Generation Process (MANDATORY STEPS)
    When the user requests code, web apps, scripts, or any programming task:
    1. FIRST: Call request_tool("openai_code_agent") to unlock the code generation capability
    2. THEN: Call gpt5_codex_agent with:
       - task: Clear description of what code to generate
       - research_context: Any relevant context or requirements (optional)
       - data_structure: Data format or API details (optional)
    3. Present the generated code to the user

    CRITICAL: Always use gpt5_codex_agent for code generation. Never write code directly in your response.

    ## PDF Document Search (Mandatory)
    When answering questions about uploaded PDFs, you MUST consult the document store BEFORE drafting any answer. If a cloud vector store (file_search) is available, call it first; if it returns no relevant results, call the local PDF DB tools once. Do NOT ask for permission to search. Do NOT answer from general knowledge without first checking the document store. Always include a compact citation footer under an `---` divider with: Doc Title, Snippet tokens, and Snippet position.

    ## ABSOLUTE RULES

    1. **ALWAYS call load_research_progress at the start of each turn**
    2. **ALWAYS call save_research_progress with your response**
    3. **ACCUMULATE progress items - never remove unless explicitly asked**
    4. **NEVER skip tool calls - they are MANDATORY**
  TEXT

  llm do
    provider "openai"
    model ["gpt-5.1", "gpt-4.1"]
    reasoning_effort "low"  # web_search requires low or higher
    context_size 30

    agents do
      code_generator model: "gpt-5.1-codex"
    end
  end

  display_name "Research Assistant"

  features do
    disabled !CONFIG["OPENAI_API_KEY"]
    websearch true
    temperature 0.0
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    mathjax true
    pdf_vector_storage true
    monadic true  # Uses Session State mechanism for research progress tracking
  end

  context_schema do
    field :topics, icon: "fa-tags", label: "Topics", description: "Research topics being investigated"
    field :findings, icon: "fa-search", label: "Findings", description: "Key findings and discoveries"
    field :sources, icon: "fa-link", label: "Sources", description: "Sources and references used"
  end

  tools do
    # Import shared file operations tools
    import_shared_tools :file_operations, visibility: "always"

    # Import unified web search tools (conditional - native or Tavily)
    import_shared_tools :web_search_tools, visibility: "conditional"

    # Research progress management tools
    define_tool "load_research_progress", "Load current research progress (topics, findings, sources) from session state" do
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "save_research_progress", "Save response and research progress to session state" do
      parameter :message, "string", "Your response message to the user", required: true
      parameter :current_topic, "string", "The current research topic", required: false
      parameter :research_topics, "array", "Research topics explored (accumulated)", required: false
      parameter :search_history, "array", "Searches performed with results (accumulated)", required: false
      parameter :findings, "array", "Key findings and insights (accumulated)", required: false
      parameter :sources, "array", "Citations and references (accumulated)", required: false
      parameter :notes, "array", "Research observations (accumulated)", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_finding", "Add a key finding with its source" do
      parameter :finding, "string", "Key finding or insight", required: true
      parameter :source, "string", "Source of the finding", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_research_topics", "Add research topics explored (accumulates without replacing)" do
      parameter :topics, "array", "Research topics to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_search", "Log a search performed" do
      parameter :query, "string", "The search query", required: true
      parameter :result_summary, "string", "Brief summary of results", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_sources", "Add citations and references (accumulates without replacing)" do
      parameter :sources, "array", "Sources to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_research_notes", "Add research observations (accumulates without replacing)" do
      parameter :notes, "array", "Notes to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    # Progressive Tool Disclosure unlock mechanism
    define_tool "request_tool", "Request access to a locked tool by name" do
      parameter :tool_name, "string", "Name of the tool to unlock", required: true
      visibility "always"
    end

    # OpenAI Code agent for analysis code generation
    define_tool "openai_code_agent", "Delegate code generation tasks to OpenAI Code" do
      parameter :task, "string", "Description of the analysis or code generation task", required: true
      parameter :research_context, "string", "Research findings or context for code generation", required: false
      parameter :data_structure, "string", "Data structure or format information", required: false
      visibility "conditional"
      unlock_when tool_request: "openai_code_agent"
      unlock_hint "Call request_tool(\"gpt5_codex_agent\") when you need to generate analysis code."
    end
  end
end
