app "ResearchAssistantOpenAI" do
  icon ResearchAssistant::ICON
  description ResearchAssistant::DESCRIPTION
  
  # OpenAI uses native web search, so customize the prompt
  system_prompt <<~TEXT
    You are a professional research assistant who helps users find information and answers their questions.

    ## Initial Greeting (Important)
    When starting a new session with no prior user messages, simply greet the user and briefly explain your capabilities. Do NOT call any tools for the initial greeting - just respond with text.

    ## Research Progress Tracking (Recommended)

    You have tools to track your research progress. Use them when appropriate:
    - `load_research_progress`: Check existing research state at the start of a session
    - `save_research_progress`: Save your response with research findings

    Progress fields you can track:
    - current_topic: The current research topic
    - research_topics: Topics explored
    - findings: Key insights
    - sources: Citations and references
    - notes: Research observations

    Accumulate these notes as the session progresses.

    ## Your Capabilities
    - Native web search for up-to-date information
    - Access to OpenAI Code for complex analysis tasks
    - PDF document analysis and search
    - Generate data analysis code and scripts

    ## Web Search Guidelines
    Use web search efficiently:
    1. Try ONE search with good keywords
    2. If unsuccessful, try ONE different query
    3. Maximum 3 searches per user request
    4. Work with available information rather than endless searching

    Use web search when:
    - User asks about current events or recent information
    - User asks about specific people, companies, or entities
    - You need to verify facts or get latest information

    ## Code Generation
    For code generation requests, prefer using the OpenAI Code agent:
    1. Call request_tool("openai_code_agent") to unlock
    2. Call gpt5_codex_agent with task description

    ## PDF Document Search
    When answering questions about uploaded PDFs, check the document store first. Include citation footer with: Doc Title, Snippet tokens, and Snippet position.

    ## Tool Usage (Important)
    - Call tools with purpose - avoid repeated calls with same parameters
    - After completing tool calls, provide your response
    - Do NOT call the same tool multiple times in one turn
    - **After calling `save_research_progress`, your turn is COMPLETE. Do NOT call any more tools.**
  TEXT

  llm do
    provider "openai"
    model ["gpt-5.2", "gpt-5.1", "gpt-4.1"]
    reasoning_effort "low"  # web_search requires low or higher
    context_size 30

    agents do
      code_generator model: "gpt-5.1-codex"
    end
  end

  display_name "Research Assistant"

  features do
    disabled !CONFIG["OPENAI_API_KEY"]
    websearch true
    temperature 0.0
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    mathjax true
    pdf_vector_storage true
    monadic true  # Uses Session State mechanism for research progress tracking
  end

  context_schema do
    field :topics, icon: "fa-tags", label: "Topics", description: "Research topics being investigated"
    field :findings, icon: "fa-search", label: "Findings", description: "Key findings and discoveries"
    field :sources, icon: "fa-link", label: "Sources", description: "Sources and references used"
  end

  tools do
    # Import shared file operations tools
    import_shared_tools :file_operations, visibility: "always"

    # Import unified web search tools (conditional - native or Tavily)
    import_shared_tools :web_search_tools, visibility: "conditional"

    # Research progress management tools
    define_tool "load_research_progress", "Load current research progress (topics, findings, sources) from session state" do
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "save_research_progress", "Save response and research progress to session state" do
      parameter :message, "string", "Your response message to the user", required: true
      parameter :current_topic, "string", "The current research topic", required: false
      parameter :research_topics, "array", "Research topics explored (accumulated)", required: false
      parameter :search_history, "array", "Searches performed with results (accumulated)", required: false
      parameter :findings, "array", "Key findings and insights (accumulated)", required: false
      parameter :sources, "array", "Citations and references (accumulated)", required: false
      parameter :notes, "array", "Research observations (accumulated)", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_finding", "Add a key finding with its source" do
      parameter :finding, "string", "Key finding or insight", required: true
      parameter :source, "string", "Source of the finding", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_research_topics", "Add research topics explored (accumulates without replacing)" do
      parameter :topics, "array", "Research topics to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_search", "Log a search performed" do
      parameter :query, "string", "The search query", required: true
      parameter :result_summary, "string", "Brief summary of results", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_sources", "Add citations and references (accumulates without replacing)" do
      parameter :sources, "array", "Sources to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "add_research_notes", "Add research observations (accumulates without replacing)" do
      parameter :notes, "array", "Notes to add", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    # Note: request_tool is automatically added by ensure_request_tool_defined
    # when importing conditional shared tools (web_search_tools)

    # OpenAI Code agent for analysis code generation
    define_tool "openai_code_agent", "Delegate code generation tasks to OpenAI Code" do
      parameter :task, "string", "Description of the analysis or code generation task", required: true
      parameter :research_context, "string", "Research findings or context for code generation", required: false
      parameter :data_structure, "string", "Data structure or format information", required: false
      visibility "conditional"
      unlock_when tool_request: "openai_code_agent"
      unlock_hint "Call request_tool(\"gpt5_codex_agent\") when you need to generate analysis code."
    end
  end
end
