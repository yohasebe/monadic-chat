app "SpeechDraftHelperOpenAI" do
  description do
    en <<~TEXT
    Draft and refine speeches and presentations.
    TEXT
    
    ja <<~TEXT
    スピーチとプレゼンテーションの作成と改善。
    TEXT
    
    zh <<~TEXT
    起草和完善演讲和演示文稿。
    TEXT
    
    ko <<~TEXT
    연설과 프레젠테이션 작성 및 개선.
    TEXT
    
    es <<~TEXT
    Redactar y perfeccionar discursos y presentaciones.
    TEXT
    
    fr <<~TEXT
    Rédiger et perfectionner discours et présentations.
    TEXT
    
    de <<~TEXT
    Reden und Präsentationen entwerfen und verfeinern.
    TEXT
  end
  
  icon "fas fa-user-tie"
  
  display_name "Speech Draft Helper"
  
  
  llm do
    provider "openai"
    model ["gpt-5.2", "gpt-5.1", "gpt-4.1"]
    reasoning_effort "none"
    temperature 0.3
  end

  system_prompt <<~TEXT
      You are a speech draft helper assistant. You can help users with their speech drafts. Users can submit a speech draft in the form of a text string, a Word file, or a PDF file. You can analyze the speech and provide a revised version of the draft. You also provide feedback on its content, structure, and delivery if the user needs them.

      ## Initial Greeting (Important)
      When starting a new session with no prior user messages, simply greet the user and briefly explain your capabilities. Do NOT call any tools for the initial greeting - just respond with text.

      ## Your Capabilities
      - Analyze and revise speech drafts
      - Provide feedback on content, structure, and delivery
      - Generate MP3 audio files from text (when requested)
      - Read text from files (text, PDF, Office documents)
      - Analyze images and audio files

      ## File Reading (Recommended)
      When the user provides a file, use the appropriate function:
      - `fetch_text_from_file`: For text files (markdown, scripts, etc.)
      - `fetch_text_from_pdf`: For PDF files
      - `fetch_text_from_office`: For Word/Excel/PowerPoint files

      ## Image and Audio Analysis
      - Use `analyze_image` when the user asks about an image
      - Use `analyze_audio` when the user provides an audio file

      ## Text-to-Speech (Recommended)
      When the user requests audio generation:
      1. First call `list_providers_and_voices` to get available options
      2. Use the exact `voice_id` value from the results (not the display name)
      3. Call `text_to_speech` with the appropriate parameters

      Available TTS providers and their output formats:
      - **openai**: Outputs MP3 format
      - **elevenlabs**: Outputs MP3 format
      - **gemini**: Outputs WAV format (not MP3) - inform user if they specifically request MP3

      If the user specifically requests MP3 format and wants to use Gemini, let them know that Gemini outputs WAV format and suggest OpenAI or ElevenLabs as alternatives for MP3.

      Parameters for `text_to_speech`:
      - `text`: The speech text to convert
      - `provider`: Provider name (default: "openai")
      - `voice_id`: Use the exact voice_id from list_providers_and_voices
      - `language`: Language code (e.g., "en", "ja")
      - `instructions`: Style instructions (OpenAI only)
      - `speed`: Speech speed (0.25-4.0 for OpenAI, 0.5-2.0 for ElevenLabs)

      Note: Long texts (1000+ words) may take 2-3 minutes to process, especially with Gemini.

      **After calling `text_to_speech`, your turn is COMPLETE:**
      - If successful: Present the audio using `<audio controls src="FILENAME"></audio>`
      - If error: Report the error to the user and ask if they want to try a different provider/voice
      - Do NOT automatically retry or call more tools

      ## Important Guidelines
      - Access each file only ONCE
      - Call `list_providers_and_voices` only ONCE per session
      - Call `text_to_speech` only ONCE per request - do NOT retry automatically on error
      - If a tool returns an error, inform the user and wait for their instruction
    TEXT

  features do
    disabled !CONFIG["OPENAI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant true
  end

  tools do
    # Import shared file operations tools (always visible - Phase 1)
    import_shared_tools :file_operations, visibility: "always"

    # Import shared content analysis tools (conditional - requires OpenAI API key)
    import_shared_tools :content_analysis_openai, visibility: "conditional"

    define_tool "fetch_text_from_file", "Fetch text content from a file" do
      parameter :file, "string", "The filename to read", required: true
    end

    define_tool "fetch_text_from_pdf", "Extract text content from a PDF file" do
      parameter :pdf, "string", "The filename of the PDF to read", required: true
    end

    define_tool "fetch_text_from_office", "Extract text content from Office files" do
      parameter :file, "string", "The filename of the Office file to read", required: true
    end

    define_tool "list_providers_and_voices", "List the available providers and voices for text-to-speech. A voice data consists of voice_id and name."

    define_tool "text_to_speech", "Convert the text to speech to generate an MP3 file and return the filename." do
      parameter :text, "string", "Text to convert to speech.", required: true
      parameter :provider, "string", "Provider of the speech.", required: false
      parameter :voice_id, "string", "Voice ID (not name) of the speech. Use the exact voice_id value from list_providers_and_voices function.", required: false
      parameter :language, "string", "Language of the speech.", required: false
      parameter :instructions, "string", "Instructions for the speech generation (optional; tone, style, etc.).", required: false
      parameter :speed, "number", "Speed of the speech (0.25 to 4.0 for OpenAI, 0.5 to 2.0 for ElevenLabs, default 1.0).", required: false
    end
  end
end