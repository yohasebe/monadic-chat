app "VideoGeneratorOpenAI" do
  description do
    en <<~TEXT
    Generate videos from text descriptions using OpenAI's Sora model. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    ja <<~TEXT
    OpenAIのSoraモデルを使ってテキスト説明からビデオ生成。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    zh <<~TEXT
    使用OpenAI的Sora模型从文本描述生成视频。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    ko <<~TEXT
    OpenAI의 Sora 모델을 사용하여 텍스트 설명에서 비디오 생성. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    es <<~TEXT
    Generar videos desde descripciones de texto usando el modelo Sora de OpenAI. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    fr <<~TEXT
    Générer des vidéos à partir de descriptions textuelles avec le modèle Sora d'OpenAI. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    de <<~TEXT
    Videos aus Textbeschreibungen mit OpenAIs Sora-Modell generieren. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "fa-solid fa-film"

  display_name "Video Generator"

  llm do
    provider "openai"
    model "gpt-5-mini"
    temperature 0.0
    context_size 10
  end

  system_prompt <<~TEXT
    You help users create videos using OpenAI's Sora 2 models.

    INITIAL GREETING:
    "Welcome! I can create videos using OpenAI's Sora 2 models:
    - **sora-2**: Fast, cost-effective (DEFAULT)
    - **sora-2-pro**: High quality, slower

    Capabilities: text-to-video, image-to-video, remix
    Sizes: 1280x720, 720x1280, 1792x1024, 1024x1792
    Duration: 4, 8, or 12 seconds
    Generation time: several minutes

    Simply describe your video or upload an image to animate!"

    WORKFLOW:

    1. **Text-to-Video:**
       - User describes a video → call generate_video_with_sora(prompt: "...")
       - Pass user's prompt unchanged

    2. **Image-to-Video (New Upload):**
       - User uploads an image with video description
       - Call generate_video_with_sora directly
       - The system automatically retrieves uploaded images from session
       - The uploaded image filename is automatically saved for later reuse

    3. **Image-to-Video (Reuse Previous Image):**
       - User wants to create another video with the previously used image
       - First, call monadic_load_state(app: "VideoGeneratorOpenAI", key: "last_images") to get the filename
       - If data exists and not null, call generate_video_with_sora(prompt: "...", image_path: filename)
       - If data is null, tell the user no previous image exists

    4. **Remix:**
       - User mentions "remix" or "modify video" → remix mode
       - System automatically retrieves video ID from session

    NOTE: You only need to use monadic_load_state for reading. Saving is automatic.

    PARAMETER DETECTION:
    - Model: sora-2 (default), sora-2-pro (for "high quality", "professional")
    - Size: 1280x720 (default), 720x1280 (portrait), 1792x1024 (wide), 1024x1792 (tall)
    - Duration: 4, 8 (default), or 12 seconds

    RESULT DISPLAY:
    Success - Output raw HTML (NO markdown code blocks):
    <div class="prompt" style="margin-bottom: 15px;"><b>Prompt</b>: [user's prompt]</div>
    <div class="generated_video">
      <video controls width="600">
        <source src="/data/[filename]" type="video/mp4" />
      </video>
    </div>

    Error:
    <div class="error-message" style="background-color: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin: 10px 0;">
      <b>Video Generation Failed</b><br/>
      [error message]
    </div>

    RULES:
    - Always call tools for video operations
    - Do not modify user's prompt
    - For reusing previous image, ALWAYS call monadic_load_state with app: "VideoGeneratorOpenAI" first
    - NEVER retry automatically on error
    - Video generation takes several minutes
  TEXT

  features do
    disabled !CONFIG["OPENAI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    image_generation "upload_only"
    video_generation true
    monadic true  # Uses Session State for tracking last used images
    group "OpenAI"
  end

  context_schema do
    field :styles, icon: "fa-palette", label: "Styles", description: "Visual styles and preferences"
    field :prompts, icon: "fa-pen", label: "Prompts", description: "Key video descriptions used"
    field :notes, icon: "fa-sticky-note", label: "Notes", description: "Important preferences to remember"
  end

  tools do
    define_tool "generate_video_with_sora", "Generate videos using OpenAI's Sora 2 models. Creates asynchronous video generation jobs." do
      parameter :prompt, "string", "Text description of the video (user's exact words, unmodified)", required: true
      parameter :model, "string", "Model to use: 'sora-2' (fast, default) or 'sora-2-pro' (high quality). Default: sora-2", required: false, enum: ["sora-2", "sora-2-pro"]
      parameter :size, "string", "Video resolution. Default: 1280x720", required: false, enum: ["1280x720", "720x1280", "1792x1024", "1024x1792"]
      parameter :seconds, "string", "Video duration in seconds. Default: 8", required: false, enum: ["4", "8", "12"]
      parameter :image_path, "string", "Filename of image in shared folder for image-to-video", required: false
      parameter :remix_video_id, "string", "Optional: ID of existing video to remix (for making targeted modifications).", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "monadic_load_state", "Load monadic session state for this app/key. Use this to retrieve the last used image filename for reuse." do
      parameter :app, "string", "App name (defaults to current app)", required: false
      parameter :key, "string", "State key to load", required: true
      parameter :default, "object", "Default value if state is missing", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end
    # Note: monadic_save_state is called automatically by generate_video_with_sora
    # Do NOT define it as a tool - LLM should not call it directly
  end
end
