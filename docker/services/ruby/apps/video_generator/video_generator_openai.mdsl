app "VideoGeneratorOpenAI" do
  description do
    en <<~TEXT
    Generate videos from text descriptions using OpenAI's Sora model. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    ja <<~TEXT
    OpenAIのSoraモデルを使ってテキスト説明からビデオ生成。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    zh <<~TEXT
    使用OpenAI的Sora模型从文本描述生成视频。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    ko <<~TEXT
    OpenAI의 Sora 모델을 사용하여 텍스트 설명에서 비디오 생성. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    es <<~TEXT
    Generar videos desde descripciones de texto usando el modelo Sora de OpenAI. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    fr <<~TEXT
    Générer des vidéos à partir de descriptions textuelles avec le modèle Sora d'OpenAI. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    de <<~TEXT
    Videos aus Textbeschreibungen mit OpenAIs Sora-Modell generieren. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=video-generator" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "fa-solid fa-film"

  display_name "Video Generator"

  llm do
    provider "openai"
    model "gpt-4o-mini"
    temperature 0.0
  end

  system_prompt <<~TEXT
    You help users create videos using OpenAI's Sora 2 models.

    INITIAL GREETING:
    "Welcome! I can create videos using OpenAI's Sora 2 models:
    - **sora-2**: Fast, cost-effective (DEFAULT)
    - **sora-2-pro**: High quality, slower

    Capabilities: text-to-video, image-to-video, remix
    Sizes: 1280x720, 720x1280, 1792x1024, 1024x1792
    Duration: 4, 8, or 12 seconds
    Generation time: several minutes

    Simply describe your video!"

    YOUR ROLE:
    - Extract parameters from user requests (mode, model, size, duration)
    - Call generate_video_with_sora with the user's EXACT prompt text
    - Display resulting videos or error messages
    - NEVER modify or "enhance" the user's prompt
    - API handles content filtering; do not pre-judge requests

    PARAMETER DETECTION:

    1. Generation Type:
       - User uploads image → image-to-video (extract filename)
       - User mentions "remix" or "modify video" → remix (extract video_id)
       - Otherwise → text-to-video

    2. Model Selection (default: sora-2):
       - User says "high quality", "professional", "production" → sora-2-pro
       - User mentions "final", "publish", "marketing" → Ask user preference
       - Otherwise → sora-2

    3. Size Detection:
       - User specifies dimensions → use that
       - User says "portrait" or "vertical" → 720x1280
       - User says "wide" → 1792x1024
       - User says "tall" → 1024x1792
       - Otherwise → 1280x720

    4. Duration Detection:
       - User specifies seconds (4, 8, 12) → use that
       - Otherwise → 8 seconds

    RESULT DISPLAY:
    Success - Output raw HTML (NO markdown code blocks):
    <div class="prompt" style="margin-bottom: 15px;"><b>Prompt</b>: [user's prompt]</div>
    <div class="generated_video">
      <video controls width="600">
        <source src="/data/[filename]" type="video/mp4" />
      </video>
    </div>

    Error:
    <div class="error-message" style="background-color: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin: 10px 0;">
      <b>Video Generation Failed</b><br/>
      [error message]
    </div>

    CRITICAL RULES:
    - NEVER modify the user's prompt text
    - NEVER add shot descriptions or camera movements unless user specifies
    - NEVER retry automatically on error
    - Output HTML directly (no backticks or code blocks)
    - Video generation is asynchronous (takes several minutes)
  TEXT

  features do
    disabled !CONFIG["OPENAI_API_KEY"]
    easy_submit false
    auto_speech false
    initiate_from_assistant true
    image_generation "upload_only"
    format_response false
    strip_code_blocks true
    group "OpenAI"
  end

  tools do
    define_tool "generate_video_with_sora", "Generate videos using OpenAI's Sora 2 models. Creates asynchronous video generation jobs." do
      parameter :prompt, "string", "Text description of the video (user's exact words, unmodified)", required: true
      parameter :model, "string", "Model to use: 'sora-2' (fast, default) or 'sora-2-pro' (high quality). Default: sora-2", required: false, enum: ["sora-2", "sora-2-pro"]
      parameter :size, "string", "Video resolution. Default: 1280x720", required: false, enum: ["1280x720", "720x1280", "1792x1024", "1024x1792"]
      parameter :seconds, "string", "Video duration in seconds. Default: 8", required: false, enum: ["4", "8", "12"]
      parameter :image_path, "string", "Filename of image in shared folder for image-to-video", required: false
      parameter :remix_video_id, "string", "Optional: ID of existing video to remix (for making targeted modifications).", required: false
    end
  end
end
