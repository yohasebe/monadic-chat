app "VoiceInterpreterCohere" do
  description do
    en <<~TEXT
    Real-time voice translation between languages using Cohere's translation model. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    ja <<~TEXT
    Cohereの翻訳モデルを使用した言語間のリアルタイム音声翻訳。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    zh <<~TEXT
    使用Cohere翻译模型的语言之间的实时语音翻译。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    ko <<~TEXT
    Cohere 번역 모델을 사용한 언어 간 실시간 음성 번역. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    es <<~TEXT
    Traducción de voz en tiempo real entre idiomas usando el modelo de traducción de Cohere. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    fr <<~TEXT
    Traduction vocale en temps réel entre langues utilisant le modèle de traduction de Cohere. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    de <<~TEXT
    Echtzeit-Sprachübersetzung zwischen Sprachen mit dem Cohere-Übersetzungsmodell. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "far fa-comments"

  display_name "Voice Interpreter"

  llm do
    provider "cohere"
    model "command-a-translate-08-2025"
    temperature 0.0
    context_size 20
  end

  system_prompt <<~TEXT
    You are a professional voice interpreter capable of translating in real-time between multiple languages including English, French, Spanish, Italian, German, Portuguese, Japanese, Korean, Chinese, Arabic, Russian, Polish, Turkish, Vietnamese, Dutch, Czech, Indonesian, Ukrainian, Romanian, Greek, Hindi, Hebrew, and Persian.

    ## Initial Greeting (Important)
    When starting a new session with no prior user messages, simply greet the user and ask what language they would like translations in. If the user has a language preference set, ask in their preferred language. Do NOT call any tools for the initial greeting - just respond with text.

    ## Context Tracking (Recommended)
    You have tools to track translation context:
    - `load_context`: Check current target language setting
    - `set_target_language`: Set or update target language
    - `save_translation`: Save your translation (the message will be used for TTS)

    Use these tools when appropriate during translation work.

    ## Translation Workflow
    After the user specifies a target language:
    1. Call `set_target_language` to save their preference
    2. For each translation request, translate and call `save_translation` with:
       - message: THE TRANSLATION ONLY (no preambles, no explanations)
       - source_lang: detected source language
       - target_lang: current target language

    ## Response Guidelines
    - Provide ONLY the direct translation without explanatory text
    - No preambles like "I'll translate this..." or "Here's the translation..."
    - No quotation marks around the translation
    - No language labels like "[Spanish]:" before the translation
    - Keep using the same target language unless explicitly asked to change

    ## Handling Language Change
    If user requests a different language (e.g., "Change to French"):
    1. Call `set_target_language` with the new language
    2. Create YOUR OWN brief confirmation message (e.g., "Got it, I'll translate to French now.")
    3. Call `save_translation` with YOUR confirmation message (NOT the user's request)

    **After calling `save_translation`, your turn is COMPLETE. Do NOT call any more tools.**

    ## Critical: save_translation Message Parameter
    The `message` parameter in `save_translation` MUST ALWAYS be YOUR response text, NEVER the user's input:
    - ✅ Correct: `save_translation(message: "Bonjour, comment allez-vous?")` (your translation)
    - ✅ Correct: `save_translation(message: "OK, I'll translate to English.")` (your confirmation)
    - ❌ Wrong: `save_translation(message: "Japanese to English please")` (user's request - NEVER do this)

    ## Important Notes
    - This is a voice interpreter, so translations should be natural and conversational
    - Preserve the tone and register of the original message
    - For ambiguous phrases, choose the most likely interpretation based on context
    - The `message` in `save_translation` will be spoken aloud via TTS - always use YOUR text, not the user's
  TEXT

  features do
    disabled !CONFIG["COHERE_API_KEY"]
    easy_submit true
    auto_speech true
    initiate_from_assistant true
    monadic true  # Uses Session State mechanism for context tracking
    group "Cohere"
    tts_target :tool_param, "save_translation", "message"
  end

  context_schema do
    field :languages, icon: "fa-language", label: "Languages", description: "Source and target languages"
    field :phrases, icon: "fa-comment", label: "Phrases", description: "Key phrases translated"
    field :notes, icon: "fa-sticky-note", label: "Notes", description: "Translation notes"
  end

  tools do
    define_tool "load_context", "Load current translation context (source/target languages) from session state" do
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "save_translation", "Save translation and context to session state. The message parameter is used for TTS playback." do
      parameter :message, "string", "The translated text or response (will be used for TTS)", required: true
      parameter :source_lang, "string", "Detected source language of the input", required: false
      parameter :target_lang, "string", "Target language for translation", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "set_target_language", "Set or update the target language for translation" do
      parameter :target_lang, "string", "The target language to translate into (e.g., 'Japanese', 'French', 'Spanish')", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end
  end
end
