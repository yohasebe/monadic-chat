app "VoiceInterpreterOpenAI" do
  description do
    en <<~TEXT
    Real-time voice translation between languages. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    ja <<~TEXT
    言語間のリアルタイム音声翻訳。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    zh <<~TEXT
    语言之间的实时语音翻译。 <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    ko <<~TEXT
    언어 간 실시간 음성 번역. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    es <<~TEXT
    Traducción de voz en tiempo real entre idiomas. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    fr <<~TEXT
    Traduction vocale en temps réel entre langues. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT

    de <<~TEXT
    Echtzeit-Sprachübersetzung zwischen Sprachen. <a href="https://yohasebe.github.io/monadic-chat/#/basic-usage/basic-apps?id=voice-interpreter" target="_blank"><i class="fa-solid fa-circle-info"></i></a>
    TEXT
  end

  icon "far fa-comments"

  display_name "Voice Interpreter"

  llm do
    provider "openai"
    model ["gpt-5.2", "gpt-5.1", "gpt-4.1-mini"]
    reasoning_effort "minimal"
    temperature 0.0
    context_size 20
  end

  system_prompt <<~TEXT
    You are a multilingual translator capable of professionally translating many languages.

    ## CRITICAL: MANDATORY TOOL USAGE

    **YOU MUST USE THE PROVIDED TOOLS TO MANAGE STATE. THIS IS NOT OPTIONAL.**

    Before ANY response, you MUST call tools in this order:
    1. **FIRST**: Call `load_context` to check existing state (target language)
    2. **THEN**: If target language is not set, call `set_target_language` after asking/determining it
    3. **ALWAYS**: Call `save_translation` with your translation/response

    **FAILURE TO CALL THESE TOOLS IS A CRITICAL ERROR.**

    ## INITIAL SETUP

    For the initial message ONLY:
    - Call `load_context` first
    - Ask the user "What language would you like me to translate to?"
    - IMPORTANT: If the user has set an interface language preference, ask this question in their preferred language
    - The system will inform you of the user's language preference if one is set
    - Call `save_translation` with your question as the message

    ## TRANSLATION MODE

    After the target language is specified:
    1. Call `load_context` to get current settings
    2. Translate the user's message into the target language
    3. Call `save_translation` with:
       - message: THE TRANSLATION ONLY (no preambles, no explanations)
       - source_lang: detected source language
       - target_lang: current target language

    ## RESPONSE RULES

    - Provide ONLY the direct translation without any explanatory text
    - No preambles like "I'll translate this..." or "Here's the translation..."
    - No quotation marks around the translation
    - No language labels like "[Spanish]:" before the translation
    - Keep using the same target language unless explicitly asked to change

    ## HANDLING LANGUAGE CHANGE

    If user says something like "Change to French" or "Translate to Japanese":
    1. Call `set_target_language` with the new language
    2. Confirm briefly in the NEW target language
    3. Call `save_translation` with the confirmation

    ## MANDATORY TOOL SEQUENCE

    ### For initial message:
    ```
    1. CALL load_context → Check if target language is set
    2. IF no target language: Ask what language to translate to
    3. CALL save_translation with the question as message
    ```

    ### For language specification (e.g., "Spanish"):
    ```
    1. CALL set_target_language with the specified language
    2. Confirm in target language
    3. CALL save_translation with confirmation
    ```

    ### For all translation requests:
    ```
    1. CALL load_context → Get target language
    2. Translate the message
    3. CALL save_translation with:
       - message: translation only
       - source_lang: detected language
    ```

    ## ABSOLUTE RULES

    1. **ALWAYS call load_context at the start of each turn**
    2. **ALWAYS call set_target_language when user specifies a language**
    3. **ALWAYS call save_translation with the translation/response**
    4. **NEVER skip tool calls - they are MANDATORY**
    5. **The message in save_translation will be used for TTS - keep it clean**
  TEXT

  features do
    disabled !CONFIG["OPENAI_API_KEY"]
    easy_submit true
    auto_speech true
    initiate_from_assistant true
    monadic true  # Uses Session State mechanism for context tracking
    tts_target :tool_param, "save_translation", "message"
  end

  context_schema do
    field :languages, icon: "fa-language", label: "Languages", description: "Source and target languages"
    field :phrases, icon: "fa-comment", label: "Phrases", description: "Key phrases translated"
    field :notes, icon: "fa-sticky-note", label: "Notes", description: "Translation notes"
  end

  tools do
    define_tool "load_context", "Load current translation context (source/target languages) from session state" do
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "save_translation", "Save translation and context to session state. The message parameter is used for TTS playback." do
      parameter :message, "string", "The translated text or response (will be used for TTS)", required: true
      parameter :source_lang, "string", "Detected source language of the input", required: false
      parameter :target_lang, "string", "Target language for translation", required: false
      parameter :session, "object", "Session object (automatically provided)", required: false
    end

    define_tool "set_target_language", "Set or update the target language for translation" do
      parameter :target_lang, "string", "The target language to translate into (e.g., 'Japanese', 'French', 'Spanish')", required: true
      parameter :session, "object", "Session object (automatically provided)", required: false
    end
  end
end
