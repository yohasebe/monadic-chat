<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover">
    <meta name="rouge-theme" content="<%= CONFIG["ROUGE_THEME"] || "pastie:light" %>">
    <title>Monadic Chat</title>

    <!-- Screen size detection and warning -->
    <script type="text/javascript">
      // Global variable to track if screen meets requirements
      let screenMeetsRequirements = true;

      function checkScreenSize() {
        const minWidth = 320; // Minimum width in pixels
        const currentWidth = window.innerWidth;
        
        // Set global flag based on screen width
        screenMeetsRequirements = (currentWidth >= minWidth);
        
        if (!screenMeetsRequirements) {
          // Hide spinner if it exists
          const spinner = document.getElementById('monadic-spinner');
          if (spinner) {
            spinner.style.display = 'none';
          }
          
          // Create overlay with warning message
          const overlay = document.createElement('div');
          overlay.id = 'screen-size-warning';
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100%';
          overlay.style.height = '100%';
          overlay.style.backgroundColor = 'rgba(255, 255, 255, 0.97)';
          overlay.style.zIndex = '10000';
          overlay.style.display = 'flex';
          overlay.style.flexDirection = 'column';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.padding = '20px';
          overlay.style.textAlign = 'center';
          overlay.style.fontFamily = "'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
          
          // Add logo/icon
          const icon = document.createElement('div');
          icon.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ffc107; font-size: 48px; margin-bottom: 20px;"></i>';
          
          // Add title
          const title = document.createElement('h2');
          title.textContent = 'Screen Size Requirements';
          title.style.color = '#333';
          title.style.marginBottom = '15px';
          
          // Add message
          const message = document.createElement('p');
          message.innerHTML = 'Monadic Chat requires a minimum screen width of 320 pixels.<br>Please use a device with a larger screen for the best experience.';
          message.style.color = '#666';
          message.style.lineHeight = '1.5';
          message.style.marginBottom = '25px';
          
          // Add current size info
          const sizeInfo = document.createElement('p');
          sizeInfo.innerHTML = `Your current screen width: <strong>${currentWidth}px</strong><br>Minimum required: <strong>${minWidth}px</strong>`;
          sizeInfo.style.color = '#888';
          sizeInfo.style.fontSize = '0.9em';
          sizeInfo.style.marginBottom = '25px';
          
          // Add option to continue anyway
          const continueButton = document.createElement('button');
          continueButton.textContent = 'Continue Anyway';
          continueButton.style.backgroundColor = '#ffc107';
          continueButton.style.color = '#000';
          continueButton.style.border = 'none';
          continueButton.style.borderRadius = '5px';
          continueButton.style.padding = '10px 15px';
          continueButton.style.cursor = 'pointer';
          continueButton.style.fontWeight = '500';
          continueButton.style.fontSize = '14px';
          continueButton.style.marginTop = '10px';
          
          continueButton.onclick = function() {
            document.body.removeChild(overlay);
            // Set a cookie to remember this choice for the session
            document.cookie = "ignore_screen_warning=true; path=/";
          };
          
          // Assemble overlay
          overlay.appendChild(icon);
          overlay.appendChild(title);
          overlay.appendChild(message);
          overlay.appendChild(sizeInfo);
          overlay.appendChild(continueButton);
          
          // Add to body when DOM is ready
          if (document.body) {
            document.body.appendChild(overlay);
          } else {
            window.addEventListener('DOMContentLoaded', function() {
              document.body.appendChild(overlay);
            });
          }
        }
      }
      
      // Check if the warning has been acknowledged already
      function hasAcknowledgedWarning() {
        return document.cookie.split('; ').some(cookie => cookie.startsWith('ignore_screen_warning=true'));
      }

      // Run screen size check when page loads and on resize
      window.addEventListener('load', function() {
        if (!hasAcknowledgedWarning()) {
          checkScreenSize();
        }
      });
      
      window.addEventListener('resize', function() {
        // Only show warning if it's not been acknowledged
        if (!hasAcknowledgedWarning()) {
          // Remove existing warning if present
          const existingWarning = document.getElementById('screen-size-warning');
          if (existingWarning) {
            document.body.removeChild(existingWarning);
          }
          checkScreenSize();
        }
      });
    </script>

    <!-- Local Montserrat font, with Google Fonts as fallback -->
    <link rel="stylesheet" href="vendor/css/montserrat.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS (local or CDN) -->
    <link rel="stylesheet" href="vendor/css/bootstrap.min.css" onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css';this.integrity='sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==';this.crossOrigin='anonymous';this.referrerPolicy='no-referrer';">

    <!-- jQuery UI CSS (local or CDN) -->
    <link rel="stylesheet" href="vendor/css/jquery-ui.min.css" onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.1/themes/base/jquery-ui.min.css';this.integrity='sha512-TFee0335YRJoyiqz8hA8KV3P0tXa5CpRBSoM0Wnkn7JoJx1kaq1yXL/rb8YFpWXkMOjRcv5txv+C6UluttluCQ==';this.crossOrigin='anonymous';this.referrerPolicy='no-referrer';">

    <!-- Font Awesome CSS (local or CDN) -->
    <link rel="stylesheet" href="vendor/css/all.min.css" onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css';this.integrity='sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==';this.crossOrigin='anonymous';this.referrerPolicy='no-referrer';">

    <!-- ABC.js CSS (local or CDN) -->
    <link rel="stylesheet" href="vendor/css/abcjs-audio.min.css" onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/abcjs@6.4.4/abcjs-audio.min.css'">
    
    <!-- Example of how to add a new library
    <link rel="stylesheet" href="vendor/css/newlib.min.css" onerror="this.onerror=null;this.href='https://cdn.example.com/newlib.min.css'">
    -->

    <link href="css/pigments-default.css?timestamp=<%= @timestamp %>" rel="stylesheet">
    <link href="css/syntax-themes.css?timestamp=<%= @timestamp %>" rel="stylesheet">
    <link href="css/monadic.css?timestamp=<%= @timestamp %>" rel="stylesheet">
    <link href="css/monadic-improvements.css?timestamp=<%= @timestamp %>" rel="stylesheet">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <style>
      /* Custom styles for ALL select elements */
      .form-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8.5L0 2.5h12z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 8px;
        padding-right: 28px !important;
        text-overflow: ellipsis;
      }
      
      /* Remove focus outline from all selects */
      .form-select:focus {
        outline: none;
        box-shadow: none;
      }
      
      /* Custom styles for AI User provider selector */
      #ai_user_provider {
        text-overflow: ellipsis;
      }
      
      /* Custom dropdown styling */
      .custom-dropdown-option {
        padding: 6px 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 0.9em;
        height: calc(1.5em + 0.5rem + 2px); /* Match the height of .form-select-sm (Bootstrap default) */
      }
      
      /* Group container styling */
      .group-container {
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }
      
      .group-container.collapsed {
        max-height: 0;
      }
      
      .custom-dropdown-option:hover {
        background-color: #f8f9fa;
      }
      
      .custom-dropdown-option.active {
        background-color: #e9ecef;
        font-weight: 500;
      }
      
      .custom-dropdown-group {
        padding: 4px 10px;
        font-weight: bold;
        background-color: #f2f2f2;
        border-bottom: 1px solid #ddd;
        color: #666;
        cursor: pointer;
        font-size: 0.85em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .custom-dropdown-group .group-toggle-icon {
        font-size: 0.8em;
        color: #777;
      }
      
      .custom-dropdown-option i {
        /* Color is now controlled in monadic.css */
        margin-right: 8px;
        font-size: 1.1em;
      }
      
      /* Custom scrollbar styles for the dropdown */
      #custom-apps-dropdown::-webkit-scrollbar {
        width: 6px;
      }
      
      #custom-apps-dropdown::-webkit-scrollbar-track {
        background: #DCDCDC;
        border-radius: 3px;
      }
      
      #custom-apps-dropdown::-webkit-scrollbar-thumb {
        background: #bbb;
        border-radius: 3px;
      }
      
      #custom-apps-dropdown::-webkit-scrollbar-thumb:hover {
        background: #999;
      }
      
      /* Enhanced styling for option elements */
      .enhanced-option {
        padding: 4px 8px;
        font-size: 0.9em;
      }
      
      .enhanced-separator {
        background-color: #f2f2f2;
        font-weight: bold;
        color: #666;
        font-size: 0.85em;
      }
      
      .enhanced-optgroup {
        font-weight: bold;
        color: #444;
      }
      /* Toggle-menu button styling removed - will use the one in the navbar directly */
      #toggle-menu:hover {
        background-color: rgba(0, 0, 0, 0.1) !important;
      }
      /* Mobile view adjustments */
      /* Media query for toggle menu removed - will rely on default styling */
      /* Media query for toggle menu (800px) removed - will rely on default styling */
      /* Cancel button with softer styling */
      #cancel_query {
        white-space: nowrap !important;
        background-color: #fef5f5; /* Very light rose background */
        border-color: #feb2b2; /* Soft rose border */
        color: #c53030; /* Soft red text */
        vertical-align: middle !important; /* Ensure vertical alignment */
        line-height: 1.5 !important; /* Match other buttons */
      }
      
      #cancel_query:hover {
        background-color: #fed7d7; /* Slightly darker rose on hover */
        border-color: #fc8181; /* Darker rose border on hover */
        color: #9b2c2c; /* Darker red text on hover */
      }
      
      #cancel_query:focus {
        box-shadow: 0 0 0 0.2rem rgba(254, 178, 178, 0.25); /* Soft focus ring */
      }
      
      /* Add spacing between icon and text for cancel button */
      #cancel_query i {
        margin-right: .25rem !important;
      }
      
      /* Initial prompt toggle buttons styling */
      #initial-prompt-toggle,
      #ai-user-initial-prompt-toggle {
        min-width: 280px; /* Set consistent width for both buttons */
        text-align: left;
        margin-bottom: 10px; /* Add vertical spacing between button and textarea */
        border-color: #dee2e6; /* Lighter default border */
        color: #6c757d; /* Softer text color */
      }
      
      #initial-prompt-toggle:hover,
      #ai-user-initial-prompt-toggle:hover {
        background-color: #f8f9fa; /* Very light background on hover */
        border-color: #adb5bd; /* Lighter border on hover */
        color: #495057; /* Slightly darker text on hover */
      }
      
      #initial-prompt-toggle:focus,
      #ai-user-initial-prompt-toggle:focus {
        box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.15); /* Softer focus ring */
      }
      
      #initial-prompt-toggle i,
      #ai-user-initial-prompt-toggle i {
        margin-right: .5rem;
      }
      
      /* Status message in navbar */
      #status-message {
        height: 28px;
        padding: 0 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        font-size: 0.875rem;
        width: 200px; /* Fixed width */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        background-color: #f8f9fa;
        line-height: 1;
        box-sizing: border-box;
      }
      
      /* Add spacing between icon and text in status message */
      #status-message i {
        margin-right: 0.5rem; /* Space between icon and text */
      }
      
      #status-message.text-success {
        background-color: #f0f9f5; /* Very light mint green */
        border-color: #c3e6cb; /* Soft green border */
        color: #155724 !important; /* Dark green text */
      }
      
      #status-message.text-warning {
        background-color: #fffaf0; /* Very light warm yellow */
        border-color: #ffeaa7; /* Soft yellow border */
        color: #856404 !important; /* Dark amber text */
      }
      
      #status-message.text-danger {
        background-color: #fef5f5; /* Very light rose */
        border-color: #f5c2c7; /* Soft rose border */
        color: #721c24 !important; /* Dark red text */
      }
      
      #status-message.text-info {
        background-color: #f0f7ff; /* Very light sky blue */
        border-color: #bee5eb; /* Soft sky blue border */
        color: #0c5460 !important; /* Dark teal text */
      }
      
      #status-message.text-primary {
        background-color: #f5f7fa; /* Very light gray-blue */
        border-color: #c8d6e5; /* Soft gray-blue border */
        color: #2c3e50 !important; /* Dark blue-gray text */
      }
      
      /* Responsive adjustments */
      @media (max-width: 900px) {
        #status-message {
          width: 150px;
        }
      }
      
      @media (max-width: 800px) {
        #status-message {
          width: 120px;
        }
      }
      
      /* Hide earlier to prevent overlap issues */
      @media (max-width: 768px) {
        #status-message {
          width: 0 !important;
          padding: 0 !important;
          border: none !important;
          overflow: hidden !important;
          opacity: 0 !important;
          margin: 0 !important;
        }
      }
      
      @media (max-width: 400px) {
        /* Only on very small screens, show icon only for cancel button */
        #cancel_query span {
          display: none;
        }
        
        #cancel_query i {
          margin-right: 0 !important;
        }
      }
      
      /* Ensure nav buttons container stays on one line */
      .nav-actions {
        display: flex;
        align-items: center;
        flex-wrap: nowrap !important;
        gap: 0.5rem; /* Consistent spacing */
      }
      
      /* Fix toggle button position regardless of status-message visibility */
      #toggle-menu {
        position: relative;
        flex-shrink: 0; /* Prevent shrinking */
      }
      
      /* Remove top margin from first h5 elements in panels */
      .shaded-panel h5:first-child,
      #menu h5:first-child {
        margin-top: 0 !important;
      }
      
      /* Add top margin to subsequent h5 elements in panels */
      .shaded-panel h5:not(:first-child),
      #menu h5:not(:first-child) {
        margin-top: 1.5rem !important;
      }
      
      /* Minimum width for Send button to ensure prominence */
      #send {
        min-width: 80px;
      }
      
      /* Session buttons layout with proper wrapping */
      .session-buttons {
        gap: 0.5rem; /* Consistent spacing between buttons */
      }
      
      .session-buttons .btn {
        margin: 0; /* Remove individual margins since we're using gap */
      }
      
      /* Primary button colors - consistent blue theme */
      .btn-primary {
        background-color: #007bff; /* Standard blue */
        border-color: #007bff;
      }
      
      .btn-primary:hover {
        background-color: #0056b3; /* Darker blue on hover */
        border-color: #0056b3;
      }
      
      .btn-primary:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }
      
      .btn-primary:active,
      .btn-primary.active {
        background-color: #0056b3; /* Same as hover for consistency */
        border-color: #004085;
      }
      
      .btn-primary:disabled {
        background-color: #6c9bd1; /* Lighter blue when disabled */
        border-color: #6c9bd1;
      }
      
      .btn-secondary {
        background-color: #718096; /* Softer gray */
        border-color: #718096;
      }
      
      .btn-secondary:hover {
        background-color: #4a5568; /* Darker gray on hover */
        border-color: #4a5568;
      }
      
      .btn-secondary:focus {
        box-shadow: 0 0 0 0.2rem rgba(113, 128, 150, 0.25);
      }
      
      /* Softer message card styling */
      .card {
        border-color: #e2e8f0; /* Softer border for all cards */
      }
      
      .card-header {
        background-color: #f7fafc; /* Very light background for headers */
        border-bottom-color: #e2e8f0;
      }
      
      /* User message cards - Blue */
      .user-color {
        color: #4CACDC; /* Existing user blue color */
      }
      
      /* Assistant message cards - Red */
      .assistant-color {
        color: #DC4C64; /* Existing assistant red color */
      }
      
      /* System message cards - Green */
      .system-color {
        color: #22ad50; /* Existing system green color */
      }
      
      /* Temp card (typing indicator) - match assistant card styling */
      #temp-card {
        border-color: #cbd5e0; /* Slightly more visible border */
      }
      
      #temp-card .card-header {
        background-color: #f7fafc; /* Light gray background to match assistant card */
      }
    </style>
   <script>
     // Set initial UI language from server (Electron app setting)
     document.cookie = "ui-language=<%= @ui_language %>; path=/; max-age=31536000";
     
     // Toggle mobile-view class when width < 1024px
     function toggleMobileView() {
       const isMobile = window.innerWidth < 1024;
       document.documentElement.classList.toggle('mobile-view', isMobile);
     }
     window.addEventListener('load', toggleMobileView);
     window.addEventListener('resize', toggleMobileView);
   </script>
  </head>
  <body>

    <!-- Responsive Navbar -->
    <nav id="main-nav" class="navbar fixed-top shaded-y">
      <div class="container-fluid d-flex align-items-center px-3" style="height: 65px;">
        <a href="#" class="navbar-brand d-flex align-items-center reset-area" style="cursor: pointer;">
          <img src="img/monadic-logo.svg" alt="Logo" class="nav-logo">
          <span class="nav-text"><span class="text-main">Monadic</span><span class="text-highlight"> Chat</span></span>
        </a>
        <div class="ms-auto d-flex align-items-center nav-actions">
          <button id="cancel_query" class="btn btn-light me-2" aria-label="Cancel Query" title="Cancel current operation" data-i18n-title="ui.cancelQuery">
            <i class="fas fa-ban"></i><span data-i18n="ui.cancelQuery">CANCEL</span>
          </button>
          <div id="status-message" class="me-2" data-i18n="ui.notStarted">Not started</div>
          <button id="toggle-menu" class="btn btn-light" aria-label="Toggle Menu" title="Toggle menu visibility" data-i18n-title="ui.toggleMenu">
            <i class="fas fa-bars"></i>
          </button>
        </div>
      </div>
    </nav>
        <div class="container-fluid pt-0 p-3" id="contents" style="margin-top: 65px; margin-bottom: 0; padding-bottom: 12px; position: relative; min-height: calc(100vh - 65px);">
      <div class="row g-3 mt-0 mb-0" style="margin-bottom: 0 !important;">
        <div id="menu" class="col-md-4 order-md-2 scrollable" style="padding-bottom: 50px;">
          <div id="monadic-info-panel" class="p-3 mb-3 rounded shaded-panel">
            <h5 class="pb-2 mb-1"><span class="text" data-i18n="ui.monadicChatInfo"><i class="fas fa-message"></i> Monadic Chat Info</span></h5>
            <div class="mb-2" style="display: flex; align-items: center;">
              <div id="monadic-homepage">
                <span class="text text-secondary"><i class="fa-solid fa-house"></i> <a href="https://yohasebe.github.io/monadic-chat/#/?id=monadic-chat" target="_blank" rel="noopener noreferrer" data-i18n="ui.homepage">Homepage</a></span>
                &nbsp;&nbsp;
                <span class="text text-secondary"><i class="fa-brands fa-github"></i> <a href="https://github.com/yohasebe/monadic-chat" target="_blank" rel="noopener noreferrer" data-i18n="ui.github">GitHub</a></span>
              </div>
            </div>
            <div class="mb-3" style="display: flex; align-items: center;">
              <div id="monadic-version">
                <span class="text text-secondary"><i class="fa-solid fa-circle-info"></i> <span data-i18n="ui.version">Version</span>:</span> <span class="text text-secondary" id="monadic-version-number"></span>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="conversation-language" class="div-label mb-1" data-i18n="ui.conversationLanguage"><i class="fa-solid fa-globe"></i> Conversation Language</label>
              <select class="form-select form-select-sm" id="conversation-language">
                <% Monadic::Utils::LanguageConfig.all_languages.each do |lang| %>
                  <option value="<%= lang[:code] %>"><%= lang[:display] %></option>
                <% end %>
              </select>
              <div class="mt-2 textbox-caption" data-i18n="ui.uiLanguageNote">UI language can be changed in system settings.</div>
            </div>

            <h5 data-i18n="ui.currentBaseApp"><span class="text"><i class="fas fa-bolt"></i></span> Current Base App</h5>
            <div style="display: flex; align-items: center;">
              <div class="icon-container">
                <span id="base-app-icon" class="app-icon"></span>
              </div>
              <div id="base-app-title" class="ms-2 like-h5"></div>
              <div class="ms-2 like-h6">
                <span id="monadic-badge" class="badge bg-secondary fw-bold" style="display: none;">monadic</span>
                <span id="tools-badge" class="badge bg-secondary fw-bold" style="display: none;">tools</span>
                <span id="websearch-badge" class="badge bg-secondary fw-bold" style="display: none;">web</span>
                <span id="math-badge" class="badge bg-secondary fw-bold" style="display: none;">math</span>
              </div>
            </div>
            <div id="base-app-desc" class="mt-2 mb-1"></div>
          </div>

          <div id="ai-status-panel" class="p-3 mb-3 rounded shaded-panel">
            <h5><span class="text" data-i18n="ui.aiAssistantAndUser"><i class="fa-solid fa-robot"></i> AI Assistant & AI User</span></h5>

            <div class="mt-3 text">
              <div class="mb-1">
                <div><span class="me-2 assistant-color fw-bold" data-i18n="ui.aiAssistant">AI Assistant</span></div>
                <div class="ps-4 text-wrap"><span id="model-selected" data-i18n="ui.notSelected">Not selected</span></div>
                <div class="ps-4 text-wrap"><span id="model-non-default" class="fw-semibold" style="display:none;">non-default model</span></div>
              </div>
              <div class="mb-1">
                <div><span class="me-2 user-color fw-bold" data-i18n="ui.aiUser">AI User</span></div>
                <div class="ps-4 text-wrap"><span id="ai-user-model" data-i18n="ui.notConfigured">Not configured</span></div>
              </div>
            </div>

            <div class="mb-2"></div>
            <h5><span class="text" data-i18n="ui.statistics"><i class="fas fa-chart-line"></i> Statistics</span></h5>
            <div id="stats-message" class="mt-3 text" data-i18n="ui.noDataAvailable">No data available</div>
          </div>

          <div id="pdf-panel" class="p-3 mb-3 rounded shaded-panel" style="display: none;">
            <h5 class="pb-2"><span class="text" data-i18n="ui.pdfDatabase"><i class="fas fa-file-pdf"></i> PDF Database</span></h5>
            <div class="d-flex align-items-center justify-content-between">
              <div class="like-h6"><i class="fas fa-database"></i> Local PDF (PGVector) <small class="text-muted" id="local-pdf-info"></small></div>
              <div class="d-flex align-items-center gap-2">
                <button id="local-pdf-refresh" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-rotate"></i> Refresh</button>
                <button id="local-pdf-clear" class="btn btn-sm btn-outline-secondary"><i class="fa-regular fa-trash-can"></i> Clear All</button>
              </div>
            </div>
            <div class="mt-2" id="pdf-titles"></div>
            <hr />
            <div class="d-flex align-items-center justify-content-between mt-3">
              <div class="like-h6"><i class="fas fa-cloud"></i> Cloud PDF (OpenAI) <small class="text-muted" id="cloud-pdf-info"></small></div>
              <div class="d-flex align-items-center gap-2">
                <button id="cloud-pdf-refresh" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-rotate"></i> Refresh</button>
                <button id="cloud-pdf-clear" class="btn btn-sm btn-outline-secondary"><i class="fa-regular fa-trash-can"></i> Clear All</button>
              </div>
            </div>
            <div id="cloud-pdf-list" class="mt-2"></div>
            <div id="cloud-pdf-meta" class="mt-1 text-muted small"></div>
          </div>

          <div id="control-panel" class="p-3 mb-3 rounded shaded-panel">
            <h5 class=""><span class="text" data-i18n="ui.sessionLabel"><i class="fas fa-file"></i> Session</span></h5>
            <div class="session-buttons d-flex align-items-center flex-wrap">
              <button class="btn btn-sm btn-warning" id="reset" title="Reset conversation while keeping current app selection" data-i18n="ui.reset"><i class="fas fa-stop" ></i> Reset</button>
              <button class="btn btn-sm btn-warning" id="load" title="Import conversation from file" data-i18n="ui.import"><i class="fas fa-file-import"></i> Import</button>
              <button class="btn btn-sm btn-warning" id="save" title="Export conversation to file" data-i18n="ui.export"><i class="fas fa-file-export"></i> Export</button>
            </div>
            <input type="file" id="fileInput" style="display:none;">
            <div class="mt-3 mb-1 textbox-caption" data-i18n="ui.resetDescription"> Press "reset" to clear conversation while keeping the current app selection.</div>
          </div>

          <div id="tts-panel" class="p-3 mb-3 rounded shaded-panel">
            <h5 class=""><span class="text" data-i18n="ui.speech"><i class="fas fa-comment-dots"></i> Speech</span></h5>

            <div class="my-1">
              <label for="tts-provider" class="div-label my-2" data-i18n="ui.textToSpeechProvider">Text-to-Speech Provider</label>
              <select class="form-select form-select-sm" id="tts-provider">
                <option id="openai-tts-4o" value="openai-tts-4o" disabled>OpenAI (4o TTS)</option>
                <option id="openai-tts" value="openai-tts" disabled>OpenAI (TTS)</option>
                <option id="openai-tts-hd" value="openai-tts-hd" disabled>OpenAI (TTS HD)</option>
                <option id="elevenlabs-flash-provider-option" value="elevenlabs-flash" disabled>ElevenLabs (Flash v2.5)</option>
                <option id="elevenlabs-multilingual-provider-option" value="elevenlabs-multilingual" disabled>ElevenLabs (Multilingual v2)</option>
                <option id="gemini-flash-provider-option" value="gemini-flash" disabled>Gemini (Flash TTS)</option>
                <option id="gemini-pro-provider-option" value="gemini-pro" disabled>Gemini (Pro TTS)</option>
                <option id="webspeech-provider-option" value="webspeech" selected>Web Speech API</option>
              </select>
            </div>

            <div id="elevenlabs-voices" class="my-1" style="display: none;">
              <label for="tts-voice" class="div-label my-2" data-i18n="ui.elevenLabsVoice">Elevenlabs Text-to-Speech Voice</label>
              <select class="form-select form-select-sm" id="elevenlabs-tts-voice">
              </select>
            </div>

            <div id="openai-voices" class="my-1">
              <label for="tts-voice" class="div-label my-2" data-i18n="ui.openAIVoice">OpenAI Text-to-Speech Voice</label>
              <select class="form-select form-select-sm" id="tts-voice">
                <option value="alloy">Alloy</option>
                <option value="ash">Ash</option>
                <option value="ballad">Ballad</option>
                <option value="coral">Coral</option>
                <option value="echo">Echo</option>
                <option value="fable">Fable</option>
                <option value="onyx">Onyx</option>
                <option value="nova">Nova</option>
                <option value="sage">Sage</option>
                <option value="shimmer">Shimmer</option>
              </select>
            </div>
            
            <div id="gemini-voices" class="my-1" style="display: none;">
              <label for="gemini-voice" class="div-label my-2" data-i18n="ui.geminiVoice">Gemini Text-to-Speech Voice</label>
              <select class="form-select form-select-sm" id="gemini-tts-voice">
                <option value="aoede">Aoede</option>
                <option value="charon">Charon</option>
                <option value="fenrir">Fenrir</option>
                <option value="kore">Kore</option>
                <option value="orus">Orus</option>
                <option value="puck">Puck</option>
                <option value="schedar">Schedar</option>
                <option value="zephyr">Zephyr</option>
              </select>
            </div>

            <div id="webspeech-voices" class="my-1" style="display: none;">
              <label for="webspeech-voice" class="div-label my-2" data-i18n="ui.webSpeechVoice">Web Speech API Voice</label>
              <select class="form-select form-select-sm" id="webspeech-voice">
                <!-- Voice options will be populated by JavaScript -->
              </select>
            </div>

            <div class="my-1">
              <label for="tts-speed" class="div-label my-2" data-i18n="ui.ttsSpeed">TTS Speed (<span id="tts-speed-value">1.00</span>)</label><br />
              <input type="range" class="div-range" min="0.70" max="1.20" step="0.01" value="1.00" id="tts-speed">
            </div>

          </div>

          <div class="mx-2 me-1" style="display: flex; align-items: center; justify-content: right;">
            <div id="author">
              <!--<span class="text text-secondary"><i class="fa-solid fa-copyright"></i> Yoichiro HASEBE 2025 </span>-->
            </div>
          </div>
        </div>

        <div id="main" class="col-md-8 order-md-1 scrollable" style="padding-bottom: 50px;">
          <div id="config" class="rounded p-3 shaded-panel">
            <h5 class="pb-0" style="color: #777; margin-top: 0.5em;"><span class="text" data-i18n="ui.systemSettings"><i class="fa-solid fa-bars"></i> System Settings</span></h5>


            <form class="row my-2">
              <div class="col-5">
                <label class="form-label" for="apps" data-i18n="ui.baseApp">Base App</label>
                <div class="position-relative">
                  <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); z-index: 5; pointer-events: none;">
                    <span id="app-select-icon" style="color: #777;"></span>
                  </div>
                  <div class="app-select-wrapper" style="position: relative; cursor: pointer;">
                    <select class="form-select form-select-sm" id="apps" style="padding-left: 36px; cursor: pointer; pointer-events: none;">
                    </select>
                    <div id="app-select-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: pointer; background-color: transparent;"></div>
                  </div>
                  <div id="custom-apps-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; max-height: 50vh; overflow-y: auto; background: white; border: 1px solid #ced4da; border-radius: 0.25rem; z-index: 1100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); scrollbar-color: #bbb #DCDCDC; scrollbar-width: thin;">
                    <!-- Options will be inserted here by JavaScript -->
                  </div>
                </div>
              </div>
              <div class="col-3 ms-2">
                <label class="form-label text-nowrap" for="context-size-toggle" data-i18n="ui.maxContextSize">Max Context Size</label>
                <div class="d-flex align-items-center gap-2">
                  <input class="form-check-input mt-0" type="checkbox" id="context-size-toggle" checked="">
                  <input type="number" id="context-size" min="1" max="9999" stop="1" value="100" class="form-control form-control-sm" />
                </div>
              </div>
              
              <div class="col-3 ms-2">
                <label class="form-label text-nowrap" for="max-tokens-toggle" data-i18n="ui.maxOutputTokens">Max Output Tokens</label>
                <div class="d-flex align-items-center gap-2">
                  <input class="form-check-input mt-0" type="checkbox" id="max-tokens-toggle" checked="checked">
                  <input type="number" id="max-tokens" stop="1" min="100" max="999999" value="4000" class="form-control form-control-sm" />
                </div>
              </div>
            </form>

            <form class="row my-3" id="model_and_file">
              <div class="col-5">
                <label for="model" class="form-label text-nowrap" data-i18n="ui.model">Model</label>
                <select class="form-select form-select-sm me-3" size="1" id="model" ></select>
              </div>

              <div class="col-auto ms-2">
                <label class="form-label text-nowrap" for="reasoning-effort" data-i18n="ui.reasoningEffort">Reasoning Effort</label>
                <div class="d-flex align-items-center gap-2">
                  <select class="form-select form-select-sm" id="reasoning-effort" style="min-width: 180px;">
                    <option value="minimal">minimal</option>
                    <option value="low">low</option>
                    <option value="medium" selected>medium</option>
                    <option value="high">high</option>
                  </select>
                  <small id="reasoning-description" class="text-muted" style="display: none; white-space: nowrap;"></small>
                </div>
              </div>
            </form>

            <!-- OpenAI PDF manager: visible only when OpenAI + supports_pdf_upload -->
            

            <!-- PDF Navigator Import Button - Separate Row -->
            <form class="row my-2" id="file-import-row" style="display: none;">
              <div class="col-auto">
                <label class="form-label" for="pdf-import" data-i18n="ui.pdfToDb">PDF → DB</label>
                <button class="btn btn-sm btn-warning text-nowrap" id="pdf-import" data-i18n="ui.importFile"><i class="fas fa-file"></i> Import File</button>
              </div>
            </form>

            <form class="row my-3" id="model_parameters">
              <div class="col-3">
                <label for="temperature" class="div-label my-2" data-i18n="ui.temperature">Temperature <small><span id="temperature-value">0.3</span></small></label><br />
                <input type="range" class="div-range" min="0.0" max="2.0" step="0.1" value="0.3" id="temperature" style="max-width: 100%;">
              </div>

              <div class="col-3">
                <label for="presence-penalty" class="div-label my-2" data-i18n="ui.presencePenalty">Presence Penalty <small><span id="presence-penalty-value">0.0</span></small></label><br />
                <input type="range" class="div-range" min="-2.0" max="2.0" step="0.1" value="0.0" id="presence-penalty" style="max-width: 100%;">
              </div>

              <div class="col-3">
                <label for="frequency-penalty" class="div-label my-2" data-i18n="ui.frequencyPenalty">Frequency Penalty <small><span id="frequency-penalty-value">0.0</span></small></label><br />
                <input type="range" class="div-range" min="-2.0" max="2.0" step="0.1" value="0.0" id="frequency-penalty" style="max-width: 100%;">
              </div>
            </form>

            <div class="row my-3">
              <div id="config-initial-prompt" class="">
                <button type="button" class="btn btn-sm btn-outline-secondary me-3" id="initial-prompt-toggle" title="Toggle initial prompt visibility">
                  <i class="fas fa-chevron-down" id="initial-prompt-icon"></i>
                  <span data-i18n="ui.initialPromptAssistant">Initial Prompt for Assistant</span>
                </button>
                <div style="display:inline-block;" class="form-check form-switch me-3">
                  <label class="form-check-label" for="prompt-caching" data-i18n="ui.promptCaching">Prompt Caching</label>
                  <input class="form-check-input" type="checkbox" id="prompt-caching" checked>
                </div>
                <div style="display:inline-block;" class="form-check form-switch me-3">
                  <label class="form-check-label" for="websearch" data-i18n="ui.webSearch">Web Search</label>
                  <input class="form-check-input" type="checkbox" id="websearch">
                </div>

                <textarea class="form-control form-control-sm" style="resize: vertical;" id="initial-prompt"></textarea>
              </div>
            </div>

            <div class="row my-3">
              <div id="config-ai-user-initial-prompt" class="">
                <button type="button" class="btn btn-sm btn-outline-secondary me-3" id="ai-user-initial-prompt-toggle" title="Toggle AI User initial prompt visibility">
                  <i class="fas fa-chevron-down" id="ai-user-initial-prompt-icon"></i>
                  <span data-i18n="ui.initialPromptAIUser">Initial Prompt for AI User</span>
                </button>
                <div style="display:inline-block;" class="form-check form-switch me-3">
                  <label class="form-check-label" for="initiate-from-assistant" data-i18n="ui.startFromAssistant">Start from assistant</label>
                  <input class="form-check-input" type="checkbox" id="initiate-from-assistant">
                </div>
                <div style="display:inline-block;" class="form-check form-switch me-3">
                  <label class="form-check-label" for="mathjax" data-i18n="ui.mathRendering">Math Rendering</label>
                  <input class="form-check-input" type="checkbox" id="mathjax">
                </div>
                <textarea class="form-control form-control-sm" style="resize: vertical;" id="ai-user-initial-prompt"></textarea>
              </div>
            </div>

            <div class="row my-3 align-items-center">
              <div class="col-12">
                <fieldset>
                  <legend data-i18n="ui.voiceConversationControls">Voice Conversation Interaction Controls&nbsp;
                    <span id="interaction-toggle-all" class="mt-2 mb-0 textbox-caption" style="font-weight: 400; cursor: pointer;" data-i18n="ui.toggleAll">
                      toggle all
                    </span>
                  </legend>
                  <div class="form-check form-switch float-start me-3" id="auto-speech-form">
                    <input class="form-check-input" type="checkbox" id="check-auto-speech">
                    <label class="form-check-label" for="check-auto-speech" data-i18n="ui.autoSpeech">Auto speech</label>
                  </div>
                  <div class="form-check form-switch float-start me-3">
                    <input class="form-check-input" type="checkbox" id="check-easy-submit">
                    <label class="form-check-label" for="check-easy-submit"><span data-i18n="ui.easySubmit">Easy submit</span> <small data-i18n="ui.easySubmitHint">(with Enter key or Stop button)</small></label>
                  </div>
                </fieldset>
              </div>
            </div>

            <div class="row my-3">
              <div id="config-initial-prompt" class="">
                <div class="form-check form-switch">
                  <label class="form-check-label" for="auto-scroll-toggle" data-i18n="ui.autoScroll">Auto scroll while streaming</label>
                  <input class="form-check-input" type="checkbox" id="auto-scroll-toggle" checked>
                </div>
              </div>
            </div>


            <div class="row mt-3">
              <div class="col-2">
                <button id="start" class="btn btn-sm btn-primary text-nowrap" disabled="disabled" title="Start or continue chat session"><i class="fas fa-rocket"></i> <span id="start-label">Start Session</span></button>
              </div>
            </div>
          </div>

          <div id="main-panel" class="rounded p-3 shaded-panel" style="display :none;">
            <h5 class="pb-0 mb-0" style="color: #777; margin-top: 0.5em;"><span class="text" data-i18n="ui.dialog"><i class="fas fa-comments"></i> Dialog</span></h5>
            <div id="discourse" style="width: 100%; overflow-y: auto; display: none;"></div>

            <div id="temp-card" class="card mt-3" style="display:none;">
              <div class="card-header p-2 ps-3 d-flex align-items-center justify-content-between">
                <div class="fs-5 card-title mb-0">
                  <span><i class='fas fa-robot' style="color: #DC4C64;"></i></span>
                  <span class='fw-bold fs-6' style="color: #DC4C64;">Assistant</span>
                </div>
                <div class="me-1 text-secondary d-flex align-items-center">
                  <span id="indicator" class="spinner spinner-grow spinner-grow-sm text-warning float-end growing-spinner"></span>
                </div>
              </div>
              <div class="card-body role-assistant">
                <div id="chat" class="card-text pt-0 color: #333; font-weight: 700"></div>
                <div id="chat-bottom" style="color: transparent;">■</div>
              </div>
            </div>

            <div id="user-panel" class="mt-1">
              <div class="row">
                <div class="col-12 h-25 mt-3">
                  <textarea id="message" class="form-control form-control-sm" style="resize: vertical; margin-bottom: 14px;" rows="4" placeholder="Type your message . . ." data-i18n-placeholder="ui.messagePlaceholder"></textarea>
                  <div class="textbox-caption" id="image-used"></div>
                  <div id="image-base64"></div>
                </div>
              </div>

              <div class="row mt-1 mb-3">
                <div class="col-auto">
                  <div class="d-flex align-items-center flex-wrap">
                    <button id="image-file" class="btn btn-sm btn-warning text-nowrap me-2" title="Attach image file to message" data-i18n="ui.image" data-i18n-title="ui.attachImage"><i class="fas fa-image"></i> Image</button>
                    <button id="doc" class="btn btn-sm btn-warning text-nowrap me-2" title="Import text from document file" data-i18n="ui.fromFile" data-i18n-title="ui.importFromDoc"><i class="fa-solid fa-file-arrow-up"></i> From file</button>
                    <button id="url" class="btn btn-sm btn-warning text-nowrap me-2" title="Import text from web URL" data-i18n="ui.fromURL" data-i18n-title="ui.importFromWeb"><i class="fa-solid fa-globe"></i> From URL</button>
                  </div>
                </div>
              </div>
              
              <!-- Voice input row - will be hidden when voice input is not available -->
              <div id="voice-input-row" class="row mb-3 align-items-center">
                <div class="col-auto d-flex align-items-center flex-wrap">
                  <div class="d-flex align-items-center">
                    <button id="voice" class="btn btn-sm btn-info text-nowrap" tabindex="1" title="Start/stop voice input recording" data-i18n="ui.speechInput" data-i18n-title="ui.startStopVoice"><i class="fas fa-microphone"></i> Speech Input</button>
                    <div id="amplitude" style="display: none; margin-left: 10px; height: 28px; overflow: hidden;">
                      <canvas id="amplitude-chart" style="width: 150px; height: 28px; max-width: 100%;" width="300" height="56"></canvas>
                    </div>
                  </div>
                  <div id="asr-p-value" class="textbox-caption ms-2"></div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-auto d-flex align-items-center">
                  <label class="form-check-label ps-1 me-1 text-nowrap" for="select-role" data-i18n="ui.role">Role</label>
                  <div style="display: inline-flex; align-items: center; max-width: 100%;">
                    <span style="font-size: 1.3em; color: #777;" id="role-icon"><i class="fa-solid fa-face-smile"></i>&nbsp;</span>
                  </div>
                  <select id="select-role" class="form-select form-select-sm me-3">
                    <option value="user">User</option>
                    <option value="sample-user">User (to add to past messages)</option>
                    <option value="sample-assistant">Assistant (to add to past messages)</option>
                    <option value="sample-system">System (to provide additional direction)</option>
                  </select>
                </div>
              </div>

              <div class="d-flex align-items-center">
                <span id="ai-assistant-info" data-model="" class="fw-bold">
                  <span style="color: #DC4C64;" data-i18n="ui.aiAssistant">AI Assistant</span>
                  &nbsp;
                  <span class="ai-assistant-provider" style="display: inline-block; padding: 0.25rem 0.5rem; border: 1px solid #dee2e6; border-radius: 0.375rem; background-color: #f8f9fa; font-weight: normal; min-width: 120px; text-align: left; font-size: 0.875rem; line-height: 1.5; height: calc(1.5em + 0.5rem + 2px); vertical-align: middle;">OpenAI</span>
                </span>
                &nbsp;<span class="text-secondary mx-2">
                  <i class="fas fa-exchange-alt"></i>
                </span>&nbsp;
                <span class="user-color fw-bold" data-i18n="ui.aiUser">AI User</span>
                &nbsp;&nbsp;
                <select id="ai_user_provider" class="form-select form-select-sm me-1" style="width: auto; min-width: 120px;">
                  <option value="openai">OpenAI</option>
                  <option value="anthropic">Anthropic</option>
                  <option value="gemini">Gemini</option>
                  <option value="cohere">Cohere</option>
                  <option value="mistral">Mistral</option>
                  <option value="perplexity">Perplexity</option>
                  <option value="deepseek">DeepSeek</option>
                  <option value="grok">Grok</option>
                </select>
                <button id="ai_user" class="btn btn-sm btn-secondary ms-1" title="Generate AI User response based on conversation"><i class="fas fa-play"></i>&nbsp;<span data-i18n="ui.run">Run</span></button>
              </div>

              <div class="row mt-3">
                <div class="col-auto">
                  <div class="d-flex align-items-center">
                    <button id="send" class="btn btn-sm btn-primary me-2" title="Send message to AI assistant" data-i18n="ui.send"><i class="fas fa-paper-plane"></i> Send</button>
                    <button id="clear" class="btn btn-sm btn-secondary me-2" title="Clear text in input field" data-i18n="ui.clear"><i class="fas fa-eraser"></i> Clear</button>
                    <button id="settings" class="btn btn-sm btn-secondary me-2" title="Show system settings panel" data-i18n="ui.settings"><i class="fas fa-bars"></i>&nbsp;Settings</button>
                  </div>
                  <div class="mt-2 ms-1 textbox-caption">
                    <span data-i18n="ui.pressToSend">Press <span class="text-secondary"> Send <i class="fas fa-paper-plane"></i></span> button to send your message.</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="resetConfirmation" tabindex="-1" aria-labelledby="resetConfirmationLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resetConfirmationLabel"><i class="fas fa-arrows-rotate"></i> <span data-i18n="ui.modals.reset">Reset</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <span data-i18n="ui.modals.resetConfirmation">Are you sure you want to reset the chat?</span>
          </div>
          <div class="modal-footer">
            <div></div>
            <button type="button" id="resetConfirmed" class="btn btn-sm btn-primary" data-bs-dismiss="modal" data-i18n="ui.modals.confirm">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="pdfDeleteConfirmation" tabindex="-1" aria-labelledby="pdfDeleteConfirmationLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pdfDeleteConfirmationLabel"><i class="fas fa-trash"></i> <span data-i18n="ui.modals.deletePDF">Delete PDF</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <span data-i18n="ui.modals.pdfDeleteConfirmation">Are you sure you want to delete</span> <span style="font-weight: bold; color: #777;" id="pdfToDelete"></span>?
          </div>
          <div class="modal-footer">
            <div></div>
            <button type="button" id="pdfDeleteConfirmed" class="btn btn-sm btn-primary" data-i18n="ui.modals.confirm">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmation" tabindex="-1" aria-labelledby="deleteConfirmationLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmationTitle"><i class="fas fa-trash"></i> <span data-i18n="ui.modals.deleteMessage">Delete Message</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p data-i18n="ui.howToDeleteMessage">How would you like to delete this message?</p>
            <p id="messageToDelete" style="color: #777;"></p>
          </div>
          <div class="modal-footer flex-column align-items-stretch">
            <button type="button" id="deleteMessageOnly" class="btn btn-sm btn-warning mb-2" data-i18n="ui.deleteMessageOnly"><i class="fa-regular fa-circle-right"></i> Delete this message only</button>
            <button type="button" id="deleteMessageAndSubsequent" class="btn btn-sm btn-warning mb-2" data-i18n="ui.deleteMessageAndBelow"><i class="fa-regular fa-circle-down"></i> Delete this message and below</button>
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal" data-i18n="ui.cancel">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- App Change Confirmation Modal -->
    <div class="modal fade" id="appChangeConfirmation" tabindex="-1" aria-labelledby="appChangeConfirmationLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="appChangeConfirmationTitle"><i class="fas fa-exchange-alt"></i> <span data-i18n="ui.modals.changeApp">Change App</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p data-i18n="ui.modals.appChangeConfirmation">Changing the app will reset all parameters and the current conversation. Do you want to continue?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal" data-i18n="ui.cancel">Cancel</button>
            <button type="button" id="appChangeConfirmed" class="btn btn-sm btn-primary" data-i18n="ui.modals.confirm">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <!-- loading procedure is implemented in monadic.rb -->
    <div class="modal fade" id="loadModal" tabindex="-1" aria-labelledby="loadModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loadModalLabel"><i class="fas fa-file-export"></i> <span data-i18n="ui.modals.loadFile">Load File</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <form action="/load" method="post" enctype="multipart/form-data" type="hidden">
            <div class="modal-body">
              <label for="file-load" class="form-label" data-i18n="ui.modals.selectFileToLoad">Select file to load</label>
              <input id="file-load" class="form-control form-control-sm" type="file" name="file" accept=".json">
            </div>
            <div class="modal-footer">
              <div></div>
              <div class="spinner-border" role="status" id="load-spinner" style="display: none;">
                <span class="visually-hidden">Loading . . .</span>
              </div>
              <button id="import-button" type="submit" value="load" class="btn btn-sm btn-primary" disabled data-i18n="ui.modals.load">Load</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="fileModalLabel"><i class="fas fa-file"></i> <span data-i18n="ui.modals.importFile">Import File</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label class="form-label" for="file-title" data-i18n="ui.modals.fileTitleOptional">File Title (Optional)</label>
            <div class="mb-3">
              <input class="form-control form-control-sm" id="file-title" placeholder=""></input>
            </div>
            <!-- Storage selection is configured globally via Settings panel (PDF Storage Mode) -->
            <label for="fileFile" class="form-label" data-i18n="ui.modals.fileToImport">File to import</label>
            <input class="form-control form-control-sm" id="fileFile" type="file" name="fileFile">
          </div>
          <div class="modal-footer">
            <div></div>
            <div class="spinner-border" role="status" id="file-spinner" style="display: none;">
              <span class="visually-hidden">Loading . . .</span>
            </div>
            <button type="submit" id="uploadFile" value="file" class="btn btn-sm btn-primary" disabled data-i18n="ui.import">Import</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="docModal" tabindex="-1" aria-labelledby="docModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="docModalLabel"><i class="fa-brands fa-markdown"></i> <span data-i18n="ui.modals.fromFile">From file</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label class="form-label" for="doc-label" data-i18n="ui.modals.labelOptional">Label (Optional)</label>
            <div class="mb-3">
              <input data-i18n="[placeholder]ui.modals.docLabelPlaceholder" placeholder="Text placed at the top of the document" class="form-control form-control-sm" id="doc-label"></input>
            </div>
            <label for="docFile" class="form-label" data-i18n="[html]ui.modals.documentToConvert">Document to convert<br />[pdf, docx, pptx, xlsx, and any text-based files]</label>
            <input class="form-control form-control-sm" id="docFile" type="file" name="docFile">
          </div>
          <div class="modal-footer">
            <div></div>
            <div class="spinner-border" role="status" id="doc-spinner" style="display: none;">
              <span class="visually-hidden">Loading . . .</span>
            </div>
            <button type="submit" id="convertDoc" value="doc" class="btn btn-sm btn-primary" disabled data-i18n="ui.modals.convert">Convert</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="urlModal" tabindex="-1" aria-labelledby="urlModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="urlModalLabel"><i class="fa-brands fa-markdown"></i> <span data-i18n="ui.modals.fromURL">From URL</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label class="form-label" for="urlLabel" data-i18n="ui.modals.labelOptional">Label (Optional)</label>
            <div class="mb-3">
              <input data-i18n="[placeholder]ui.modals.urlLabelPlaceholder" placeholder="Text placed at the top of the webpage contents" class="form-control form-control-sm" id="urlLabel"></input>
            </div>
            <label for="pageURL" class="form-label" data-i18n="ui.modals.urlToFetch">URL of the page to fetch</label>
            <div class="mb-3">
              <input placeholder="URL must start with http:// or https://" class="form-control form-control-sm" id="pageURL"></input>
            </div>
          </div>
          <div class="modal-footer">
            <div></div>
            <div class="spinner-border" role="status" id="url-spinner" style="display: none;">
              <span class="visually-hidden">Loading . . .</span>
            </div>
            <button type="submit" id="fetchPage" value="url" class="btn btn-sm btn-primary" disabled data-i18n="ui.modals.convert">Convert</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="imageModalLabel"><i class="fas fa-image"></i> <span data-i18n="ui.modals.selectFile">Select File</span></h5>
            <button type="button" class="btn btn-sm btn-close" data-bs-dismiss="modal" style="box-shadow:none;" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="imageFile" class="form-label" data-i18n="ui.modals.fileToImportLabel">File to import (.pdf, .jpg, .jpeg, .png, .gif)</label>
            <input class="form-control form-control-sm" id="imageFile" type="file" name="imageFile" accept=".pdf,.jpg,.jpeg,.png,.gif">
          </div>
          <div class="modal-footer">
            <div id="select_image_error" class="size-error text-warning mb-2"></div>
            <button type="submit" id="uploadImage" value="image" class="btn btn-sm btn-primary" disabled data-i18n="ui.import">Import</button>
          </div>
        </div>
      </div>
    </div>
    <!-- FontAwesome Spinner `#spinner i`-->
    <div id="monadic-spinner">
      <span data-i18n="ui.messages.spinnerStarting"><i class="fas fa-comment fa-pulse"></i> Starting</span>
    </div>

    <!-- JavaScript -->
    <!-- Bootstrap JS (local or CDN) -->
    <script src="vendor/js/bootstrap.bundle.min.js" onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js';this.integrity='sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg==';this.crossOrigin='anonymous';this.referrerPolicy='no-referrer';"></script>

    <!-- jQuery (local or CDN) -->
    <script src="vendor/js/jquery.min.js" onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js';this.integrity='sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw==';this.crossOrigin='anonymous';this.referrerPolicy='no-referrer';"></script>

    <!-- jQuery UI (local or CDN) -->
    <script src="vendor/js/jquery-ui.min.js" onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.1/jquery-ui.min.js';this.integrity='sha512-MSOo1aY+3pXCOCdGAYoBZ6YGI0aragoQsg1mKKBHXCYPIWxamwOE7Drh+N5CPgGI5SA9IEKJiPjdfqWFWmZtRA==';this.crossOrigin='anonymous';this.referrerPolicy='no-referrer';"></script>

    <!-- Opus Media Recorder (local or CDN) -->
    <script src="vendor/js/OpusMediaRecorder.umd.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/opus-media-recorder@0.8.0/OpusMediaRecorder.umd.js';"></script>
    <script src="vendor/js/encoderWorker.umd.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/opus-media-recorder@0.8.0/encoderWorker.umd.js';"></script>

    <script src="js/mathjax-config.js"></script>
    <!-- MathJax (local or CDN) -->
    <script src="vendor/js/tex-mml-chtml.min.js" onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js';this.crossOrigin='anonymous';this.referrerPolicy='no-referrer';"></script>
    
    <!-- Custom MathJax Styling -->
    <style>
      /* Force MathJax to use serif fonts */
      .MathJax {
        font-family: "Computer Modern", "Latin Modern", "Latin Modern Math", "STIX Two Math", "STIX", "TeX", serif !important;
      }
      
      /* Adjust inline math size to match surrounding text */
      .mjx-math {
        font-size: 100% !important;
      }
      
      /* Better spacing between characters */
      .mjx-char {
        letter-spacing: 0.02em;
      }
      
      /* Adjust vertical alignment of inline math */
      mjx-container[display="false"] {
        vertical-align: middle !important;
      }
    </style>

    <!-- Mermaid (local or CDN) -->
    <script src="vendor/js/mermaid.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js';"></script>

    <!-- ABC.js (local or CDN) -->
    <script src="vendor/js/abcjs-basic-min.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/abcjs@6.4.4/dist/abcjs-basic-min.min.js';"></script>
    
    <!-- Debug configuration - must be loaded before all other scripts -->
    <script src="js/debug-config.js?timestamp=<%= @timestamp %>"></script>

    <script src="js/monadic/model_spec.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/reasoning-mapper.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/reasoning-labels.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/reasoning-ui-manager.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/model_loader.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/version-utils.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/cards.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/session_state.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/model_utils.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/utilities.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/shims.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/ui-config.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/ui-state.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/error-handler.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/dom-cache.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/performance-monitor.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/ui-utilities.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/form-handlers.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/websocket-handlers.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/websocket.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/websearch_tavily_check.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/tts.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/recording.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/select_image.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/mask_editor.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/syntax-theme-handler.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/i18n/translations.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic/utilities_websearch_patch.js?timestamp=<%= @timestamp %>"></script>
    <script src="js/monadic-improvements.js?timestamp=<%= @timestamp %>"></script>
    
    <!-- Make sure clipboard operations work in DevTools -->
    <script>
      // Apply shims module after everything else is loaded
      window.addEventListener('load', function() {
        if (window.installShims) {
          window.installShims();
        }
      });
    </script>
    
    <!-- No inline styles - all styles moved to monadic.css -->
    
    <!-- Scroll buttons - outside main container for proper floating -->
    <div id="back_to_bottom" role="button" aria-label="Scroll to bottom" tabindex="0">
      <a href="#" aria-hidden="true"><i class="fas fa-arrow-down"></i></a>
    </div>
    <div id="back_to_top" role="button" aria-label="Scroll to top" tabindex="0">
      <a href="#" aria-hidden="true"><i class="fas fa-arrow-up"></i></a>
    </div>
  </body>
</html>
