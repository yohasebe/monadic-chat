# Basic Architecture

Monadic Chat provides advanced features that cannot be achieved with just the language model API by incorporating a virtual environment built as a Docker container into the system.

Both users and AI agents can access the Docker container, allowing them to collaborate through natural language communication to bring about changes in the environment. Specifically, under the user's instructions, the AI agent can install commands, learn how to use them, execute commands, and return results.

It also provides a mechanism for sharing data between the host computer and individual Docker containers. This allows users to seamlessly collaborate with the virtual environment, providing necessary files to the AI agent and retrieving files generated by the AI agent.

![Basic Architecture](../assets/images/basic-architecture.png ':size=800')

## Server and Standalone Modes :id=server-standalone-modes

Monadic Chat can operate in two primary modes:

### Standalone Mode :id=standalone-mode
- Default operating mode
- All components run on a single machine
- Docker containers, web server, and UI are on the same device
- Network bindings use `127.0.0.1` (localhost) for enhanced security
- Only accessible from the device it runs on
- All features including Jupyter Notebook are available

### Server Mode :id=server-mode
- Enables multiple clients to connect to a central server
- Server hosts Docker containers and web services
- Clients connect through their web browsers
- Network bindings use `0.0.0.0` (all network interfaces)
- Network URLs use the server's external IP address
- Enables sharing resources across multiple users
- Jupyter-related features are disabled for security reasons

>! **Security Warning**: When exposing Monadic Chat in Server Mode to external networks, especially the internet, implement appropriate security measures such as firewalls, reverse proxies, and authentication mechanisms. The default configuration has no built-in authentication, so it should only be used on trusted networks or with additional security layers.

To switch between modes in the desktop application:

1. Click on the settings icon in the top-right corner
2. Choose either "Standalone Mode" or "Server Mode"
3. Save and restart the application when prompted

To enable Server Mode when running from source code, set the environment variable `DISTRIBUTED_MODE=server` when starting Monadic Chat.

## Standard Docker Containers :id=standard-containers

This section explains the standard Docker containers available in Monadic Chat. By default, the following containers are built:

### Ruby Container (`monadic-chat-ruby-container`) :id=ruby-container
This container is necessary to run Monadic Chat applications. It is also used to provide the web interface.
- **Port**: 4567 (Web interface)
- **Main features**: Sinatra web server, WebSocket support, Docker management
- **Shared volumes**: `/monadic/data`, `/monadic/config`, `/monadic/log`
- **Apps that require this container**: All apps (this is the core container that runs the web interface and manages all Monadic Chat functionality)

### Python Container (`monadic-chat-python-container`) :id=python-container
This container is used to run Python scripts that extend the functionality of Monadic Chat. JupyterLab and a Flask API server also run on this container.
- **Ports**: 
  - 8889 (JupyterLab)
  - 5070 (Flask API server for tokenization and other services)
- **Main features**: Python code execution, JupyterLab, Flask API server, LaTeX support (for diagram generation), tokenization services
- **Apps that use this container**: 
  - `Code Interpreter` - Executes Python code for data analysis and calculations
  - `Jupyter Notebook` - Interactive notebook interface for code execution
  - `Video Describer` - Analyzes video files using Python libraries
  - `Syntax Tree` - Generates linguistic syntax trees using LaTeX/TikZ
  - `Concept Visualizer` - Creates conceptual diagrams using LaTeX/TikZ
  - Any app using `run_code` or `run_script` tools for Python execution

### Selenium Container (`monadic-chat-selenium-container`) :id=selenium-container
This container is used to operate a virtual web browser using Selenium for web scraping.
- **Ports**: 4444, 5900, 7900 (Selenium Grid)
- **Main features**: Chrome browser automation, web scraping
- **Apps that use this container**: 
  - `Code Interpreter` - Can use Selenium for web scraping tasks
  - `Content Reader` - Fetches and extracts content from web pages
  - `Mermaid Grapher` - Validates Mermaid diagrams and creates preview screenshots
  - `Research Assistant` - Uses web scraping for gathering information
  - `Visual Web Explorer` - Captures web page screenshots and extracts text content
  - Any app using `fetch_html_content` or `selenium_agent` tools

### pgvector Container (`monadic-chat-pgvector-container`) :id=pgvector-container
This container is used to store text embedding vector data on PostgreSQL for using pgvector.
- **Port**: 5433 (host) → 5432 (container)
- **Main features**: Vector similarity search, PDF content storage, help database
- **Apps that use this container**: 
  - `PDF Navigator` - Stores and searches PDF content using embeddings
  - `Monadic Chat Help` - Searches documentation using vector similarity
  - Any custom RAG (Retrieval-Augmented Generation) apps using the TextEmbeddings class


## Container Requirements by App Type :id=container-requirements

### Minimal Setup :id=minimal-setup
For basic chat functionality, only the Ruby container is strictly required. Apps that work with just the Ruby container include:
- Chat (all providers)
- Voice Chat
- Mail Composer
- Coding Assistant (without code execution)
- Language Practice
- Novel Writer
- Translate

### Extended Functionality :id=extended-functionality
The following containers enable additional features:

**Python Container**: Required for:
- Code execution (Code Interpreter, Jupyter Notebook)
- Diagram generation (Syntax Tree, Concept Visualizer)
- Video analysis (Video Describer)
- Any app using LaTeX rendering
- Provides Flask API server on port 5070 for tokenization services

**Selenium Container**: Required for:
- Web content fetching (Content Reader, Research Assistant)
- Mermaid diagram validation and preview
- Web scraping functionality

**pgvector Container**: Required for:
- PDF content search (PDF Navigator)
- Help system (Monadic Chat Help)
- Custom RAG applications

?> For more information on adding Docker containers to extend the functionality of Monadic Chat, see [Adding Docker Containers](../advanced-topics/adding-containers.md).

## Optional Docker Containers :id=optional-containers

In addition to the standard containers, Monadic Chat supports optional containers:

- **Ollama Container** (`monadic-chat-ollama-container`): Provides local LLMs via [Ollama](https://ollama.com). This container is built on demand using Actions → Build Ollama Container (not included in "Build All"). Models are stored in `~/monadic/ollama/` and persist across container rebuilds. See [Using Ollama](../advanced-topics/ollama.md) for setup instructions.

## Container Network Architecture :id=network-architecture

All containers communicate through a shared Docker network:

### Network Configuration :id=network-configuration
- **Network name**: `monadic-chat-network`
- **Network driver**: Bridge
- **Inter-container communication**: Enabled using container names as hostnames

### Container Dependencies and Startup Order :id=container-dependencies
1. **pgvector** starts first (provides database services)
2. **Selenium** starts next (provides browser automation)
3. **Python** starts after Selenium (may use Selenium for certain operations)
4. **Ruby** starts last (depends on pgvector with health check, and Python)

This startup order ensures all required services are available when dependent containers start.

### Shared Data Volumes :id=shared-volumes
All containers share access to:
- **User data**: `~/monadic/data` (mounted as `/monadic/data` in containers)
- **Configuration**: Ruby container has exclusive access to `/monadic/config`
- **Logs**: Ruby container has exclusive access to `/monadic/log`

## Container Rebuilding Process :id=rebuilding-process

When the application is updated, Monadic Chat intelligently determines which containers need to be rebuilt:

1. For new installations, all containers are built from scratch
2. On version updates:
   - The system checks if Dockerfiles for Python, Selenium, and PGVector containers have changed
   - If changes are detected, a full rebuild of all containers is performed
   - If no changes are detected, only the Ruby container is rebuilt

This optimized rebuilding process saves time during updates when only Ruby code has changed, which is the most common update scenario.
## Orchestration Health & Auto-Recovery

At startup, the Ruby control-plane coordinates services and verifies health. If it detects the control-plane is not yet ready to manage updated containers (e.g., after Python or user container builds), it performs a single, cache-friendly refresh of the Ruby container and continues startup. This is presented to the user as informational status (not a warning), followed by a green success when ready.

Diagnostics
- The final startup summary lives in `~/monadic/log/docker_startup.log`.
- When auto-refresh is invoked you will see: `Auto-rebuilt Ruby due to failed health probe`.
- You can tune the probe with `START_HEALTH_TRIES` and `START_HEALTH_INTERVAL` in `~/monadic/config/env`.
