# ベクトルデータベース

Monadic Chatには、意味検索機能を実現する強力なベクトルデータベースシステムが組み込まれています。このドキュメントでは、このシステムがどのように動作し、アプリケーションでどのように使用されているかを説明します。

## 概要 :id=overview

Monadic Chatのベクトルデータベース機能は以下のことを行います：
- テキストを数値ベクトル表現（エンベディング）に変換
- これらのベクトルをpgvectorを使用してPostgreSQLデータベースに格納
- 単なるキーワードマッチングではなく、意味的類似性に基づく検索を可能に
- PDF NavigatorアプリとMonadic Helpアプリで使用されています

## 技術的実装 :id=technical-implementation

### データベースコンテナ

ベクトルデータベース機能はpgvectorコンテナ（`monadic-chat-pgvector-container`）上で動作します。このコンテナは下記を行います：
- pgvector拡張機能を搭載したPostgreSQLを実行
- 高性能なベクトル保存と類似性検索を提供
- ドキュメントの内容とそのベクトル表現の両方を保存


### テキスト処理フロー

![ベクトルデータベース利用のフロー](../assets/images/rag.png ':size=700')

PDF Navigatorアプリでの処理フローは以下の通りです：

> 📸 **スクリーンショットが必要**: PDFアップロードとクエリインターフェースを表示するPDF Navigatorアプリ

1. **テキスト抽出**： 
   - PDFはPyMuPDFを使用して生テキストを抽出
   - テキストは設定可能なトークンサイズ制限（デフォルト：セグメントあたり4000トークン）でセグメントに分割
   - コンテキストを維持するために、設定可能な行数（デフォルト：4行）のオーバーラップを連続するセグメント間に設定
   - これらの値は`~/monadic/config/env`ファイルで設定変数として設定可能：`PDF_RAG_TOKENS`と`PDF_RAG_OVERLAP_LINES`

2. **エンベディング生成**：
   - 各テキストセグメントはOpenAIの`text-embedding-3-large`モデルを使用してベクトル表現に変換
   - これらのエンベディングはテキストの意味的内容を保持
   - エンベディングベクトルは3072次元

3. **ベクトル保存**：
   - テキストセグメントとそのベクトル表現の両方をPostgreSQLデータベースに保存
   - pgvector拡張機能により効率的なベクトル操作が可能に

4. **検索プロセス**：
   - ユーザーが質問すると、その質問もエンベディングベクトルに変換
   - システムは質問に最も類似したエンベディングを持つテキストセグメントを検索
   - これらの関連セグメントがユーザーの質問と共にLLMに提供
   - LLMはこれらの関連テキストセグメントに基づいて回答を生成

## データベーススキーマ :id=database-schema

ベクトル保存のためのデータベーススキーマ：

- **docs**: アップロードされたドキュメントに関するメタデータを保存
  - `id`: ドキュメントのユニークな識別子
  - `title`: ドキュメントのタイトル
  - `items`: ドキュメント内のテキストセグメント数
  - `metadata`: JSON形式のドキュメントに関する追加情報
  - `embedding`: ドキュメント全体の結合エンベディングベクトル

- **items**: テキストセグメントとそのエンベディングを保存
  - `id`: テキストセグメントのユニークな識別子
  - `doc_id`: 親ドキュメントへの参照
  - `text`: セグメントのテキスト内容
  - `position`: ドキュメント内での順序位置
  - `embedding`: テキストのベクトル表現（pgvectorを使用して保存）
  - `metadata`: JSON形式の補足情報

`metadata`フィールドは主に各セグメントのトークン数を保存し、LLMが取得されたテキストセグメントのサイズを理解するのに役立ちます。

## PDF Navigatorでの使用 :id=use-in-pdf-navigator

PDF Navigatorアプリはこのシステムを活用して、インテリジェントなドキュメントQ&A機能を提供します：

1. ユーザーはUI経由でPDFドキュメントをアップロード
2. システムは上記のように文書を処理
3. ユーザーはドキュメントの内容について質問できる
4. システムはベクトル類似性検索を使用して最も関連性の高いセグメントを取得
5. これらのセグメントがLLMに提供され、情報に基づいた回答が生成される

本アプリでは、各回答に使用されたドキュメントとテキストセグメントも表示し、ユーザーに情報源を明確に伝えます。

## Monadic Helpでの使用 :id=use-in-monadic-help

Monadic Chatはベクトルストレージ用に2つの別々のデータベースを使用します：
- `monadic_user_docs` - PDF NavigatorアプリでユーザーがアップロードしたPDFドキュメント用
- `monadic_help` - Monadic Helpアプリの組み込みドキュメント検索用

Monadic Helpアプリは、次のようにベクトルデータベースシステムを使用します：

1. ドキュメントファイルはビルドプロセス中に事前処理され、埋め込まれます
2. ヘルプデータベースはMonadic Chatの初回起動時に自動的にビルドされます
3. ユーザーがMonadic Chatについて質問すると、システムは埋め込まれたドキュメントを検索します
4. 関連するドキュメントセクションが取得され、LLMに提供されて有用な回答が生成されます

ヘルプシステムは同じ`text-embedding-3-large`モデルを使用しますが、ドキュメント検索をユーザーデータから分離するために、エンベディングを別のデータベースに保持します。なお、データベースは自動的にビルドされますが、検索機能にはエンベディングモデルが必要なため、Monadic Helpアプリを使用するにはOpenAI APIキーが必要です。
