# ベクトルデータベース

Monadic Chatには、意味検索機能を実現する強力なベクトルデータベースシステムが組み込まれています。このドキュメントでは、このシステムがどのように動作し、アプリケーションでどのように使用されているかを説明します。

## 概要

Monadic Chatのベクトルデータベース機能は以下のことを行います：
- テキストを数値ベクトル表現（埋め込み）に変換
- これらのベクトルをpgvectorを使用してPostgreSQLデータベースに格納
- 単なるキーワードマッチングではなく、意味的類似性に基づく検索を可能に
- 現在はPDF Navigatorアプリでのみ使用しています

## 技術的実装

### データベースコンテナ

ベクトルデータベース機能はpgvectorコンテナ（`monadic-chat-pgvector-container`）上で動作します。このコンテナは下記を行います：
- pgvector拡張機能を搭載したPostgreSQLを実行
- 高性能なベクトル保存と類似性検索を提供
- ドキュメントの内容とそのベクトル表現の両方を保存

### テキスト処理フロー

![ベクトルデータベース利用のフロー](./assets/images/rag.png ':size=800')

PDF Navigatorアプリでの処理フローは以下の通りです：

1. **テキスト抽出**： 
   - PDFはPyMuPDFを使用して生テキストを抽出
   - テキストはセグメントあたり2000トークンの固定トークンサイズ制限でセグメントに分割
   - コンテキストを維持するために、連続するセグメント間に2行のオーバーラップ部分を設定

2. **埋め込み生成**：
   - 各テキストセグメントはOpenAIの埋め込みモデルを使用してベクトル表現に変換
   - これらの埋め込みはテキストの意味的内容を保持

3. **ベクトル保存**：
   - テキストセグメントとそのベクトル表現の両方をPostgreSQLデータベースに保存
   - pgvector拡張機能により効率的なベクトル操作が可能に

4. **検索プロセス**：
   - ユーザーが質問すると、その質問も埋め込みベクトルに変換
   - システムは質問に最も類似した埋め込みを持つテキストセグメントを検索
   - これらの関連セグメントがユーザーの質問と共にLLMに提供
   - LLMはこれらの関連テキストセグメントに基づいて回答を生成

## データベーススキーマ

ベクトル保存のためのデータベーススキーマ：

- **docs**: アップロードされたドキュメントに関するメタデータを保存
  - `id`: ドキュメントのユニークな識別子
  - `title`: ドキュメントのタイトル
  - `created_at`: ドキュメントが追加された時のタイムスタンプ

- **texts**: テキストセグメントとその埋め込みを保存
  - `id`: テキストセグメントのユニークな識別子
  - `doc_id`: 親ドキュメントへの参照
  - `text`: セグメントのテキスト内容
  - `position`: ドキュメント内での順序位置
  - `embedding`: テキストのベクトル表現（pgvectorを使用して保存）
  - `metadata`: JSON形式の補足情報。
  -

`metadata`は主に`tokens`キーを使用してトークン数情報を保存します。このメタデータはLLMに返され、テキストセグメントのサイズに関するコンテキストを提供します。

## PDF Navigatorでの使用

PDF Navigatorアプリはこのシステムを活用して、インテリジェントなドキュメントQ&A機能を提供します：

1. ユーザーはUI経由でPDFドキュメントをアップロード
2. システムは上記のように文書を処理
3. ユーザーはドキュメントの内容について質問できる
4. システムはベクトル類似性検索を使用して最も関連性の高いセグメントを取得
5. これらのセグメントがLLMに提供され、情報に基づいた回答が生成される

本アプリでは、各回答に使用されたドキュメントとテキストセグメントも表示し、ユーザーに情報源を明確に伝えます。
