# Mermaid Grapher: レンダリングノート

## Unicode正規化

Mermaid.jsはASCII矢印（`-->`）とラベル内のプレーン引用符を期待します。最近のGPT出力には時々次のものが含まれます：

- `-`の代わりにUnicodeダッシュ（`–`、`—`、`ー`など）
- スマート引用符（`""`、`''`、`「」`）
- 全角スラッシュ（`／`）または括弧内の繰り返しの空行

検証/レンダリングの前に正規化します：

- LLMから返されたHTMLエンティティをデコード
- Unicodeダッシュを`-`に置換
- スマート引用符/日本語スタイルの引用符をASCIIに変換
- `[ ... ]`内の空行を折りたたみ、改行を`\n`として書き直す

`sanitize_mermaid_code`または`sanitizeMermaidSource`に触れる場合は、これらのステップを保持してください。

## HTML埋め込み

MermaidコードをプレビューHTMLに埋め込む際、現在は`<`、`>`、`&`のみをエスケープします。引用符はリテラルのままなので、ラベルが正しくレンダリングされます。将来の変更はこの動作を保持する必要があります。

## プレビューガードレール

`preview_mermaid`は、まったく同じコードに対して最新の`validate_mermaid_syntax`が成功しない限り実行を拒否します。ツールを再実行する前に、常にツールレスポンスの`next_action`をチェックしてください。ワークフロー：

1. `validate_mermaid_syntax`を呼び出す（失敗時に最大3回再試行）
2. `workflow_status: validation_passed`の場合のみ`preview_mermaid`を実行
3. 最終回答で返された`validated_code`を使用

## フロントエンドヘルパー

`sanitizeMermaidSource`はバックエンドの正規化を模倣するため、`<mermaid>`内のMermaidスニペットがプレビューPNG出力と一致します。バックエンドロジックを変更する場合は、それに応じてフロントエンドヘルパーを更新してください。
