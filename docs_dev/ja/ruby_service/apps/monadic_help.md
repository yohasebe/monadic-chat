# Monadic ヘルプシステム

Monadic ヘルプシステムは、Monadic Chatユーザーのためのインテリジェントなドキュメント検索とアシスタンスを提供します。

## 機能

1. **埋め込みのバッチ処理**
   - パフォーマンス向上のために複数のテキストチャンクをバッチで処理
   - `HELP_EMBEDDINGS_BATCH_SIZE`環境変数で設定可能なバッチサイズ
   - デフォルトバッチサイズ：50（OpenAI制限で最大2048）

2. **マルチチャンク検索結果**
   - より良いコンテキストのためにドキュメントごとに複数のテキストチャンクを返す
   - `HELP_CHUNKS_PER_RESULT`環境変数で設定可能
   - デフォルト：ドキュメントごとに3チャンク
   - 結果は平均類似度スコアでドキュメントごとにグループ化

3. **増分更新**
   - MD5ハッシュを使用して変更されたドキュメントを検出
   - 変更されたファイルの埋め込みのみを再構築
   - ドキュメントメタデータにコンテンツハッシュを保存
   - ドキュメントが変更されていない場合の再構築が大幅に高速化

4. **英語のみのドキュメント**
   - 英語のドキュメントファイルのみを処理（/ja、/zh、/koディレクトリを除外）
   - LLMがユーザーの優先言語への翻訳を処理
   - データベースサイズと処理時間を削減

## 設定

### 環境変数

- `HELP_EMBEDDINGS_BATCH_SIZE`：各埋め込みバッチで処理するテキストの数（デフォルト：50）
- `HELP_CHUNKS_PER_RESULT`：検索結果でドキュメントごとに返すテキストチャンクの数（デフォルト：3）
- `EMBEDDINGS_DEBUG`：埋め込み処理のデバッグログを有効化

### ヘルプデータベースの構築

```bash
# 初期構築
rake help:build

# 完全再構築（既存データを削除）
rake help:rebuild

# 統計を表示
rake help:stats
```

## 実装詳細

### バッチ処理
システムは現在、OpenAIのバッチ埋め込みAPIを使用して、単一のリクエストで複数のテキストを処理します：
- API呼び出しを削減し、パフォーマンスを向上
- 設定可能なサイズで自動的にバッチ処理を行う
- 埋め込みの正しい順序を維持

### 検索の改善
- `find_help_topics`：包括的なコンテキストのためにドキュメントごとに複数のチャンクを返す
- `search_help_by_section`：マルチチャンクサポートでドキュメントセクションごとに結果をフィルタリング
- 結果には、より良いランキングのための平均類似度スコアが含まれる

### 増分更新
- 各ドキュメントはそのコンテンツのMD5ハッシュを保存
- 再構築中、変更されたハッシュを持つドキュメントのみが再処理される
- タイムスタンプはドキュメントが最後に更新された時を追跡

### 言語処理
- ドキュメントは英語のみで保存
- LLMはユーザー言語を検出し、それに応じてレスポンスを翻訳
- ストレージ要件を削減し、メンテナンスを簡素化
