# モデル仕様メンテナンスガイド

このドキュメントは、`model_spec.js`およびそれを読み取るRubyヘルパーレイヤーをメンテナンスするための運用ルールを定義します。プロバイダーモデルを追加、名前変更、または廃止する際の正式なプレイブックとして扱ってください。

## 信頼できる情報源

- `docker/services/ruby/public/js/monadic/model_spec.js`は、モデル機能（トークン制限、フラグ、プリセット）の唯一の信頼できる情報源です。
- Rubyは`ModelSpecUtils`を介してJSファイルをパースすることで同じ情報を読み取ります。
- 他のファイルは権威ある機能テーブルやハードコードされたモデル名を持つことはできません。派生データ（テスト、ドキュメント）は常に`model_spec.js`の変更から再生成する必要があります。

## 不変条件

1. **機能駆動のルックアップ**：ランタイムコードは、リテラルモデルIDを参照する代わりに、ヘルパー（例：`ModelSpecUtils.default_for(provider)`または`ModelTokenUtils`）を呼び出す必要があります。
2. **環境オーバーライドのみ**：各プロバイダーのデフォルトは`Monadic::Utils::SystemDefaults`に存在します。これらはUIが公開するものをミラーリングし、`ENV`オーバーライドを尊重する必要があります。
3. **ドキュメントはプロバイダーを参照し、SKUは参照しない**：公開ドキュメントはプロバイダーのモデルページにリンクします。SKUのハードコードされたリストを公開することはありません。内部ドキュメントはプレースホルダーに言及する場合がありますが、開発者が公式IDに置き換えることを明記する必要があります。
4. **Lintガードレール**：`scripts/lint/check_deprecated_models.rb`は、`config/deprecated_model_terms.txt`の下の禁止モデル用語リストを強制します。`model_spec.js`を変更する前に許可/拒否リストを更新してください。

## 変更ワークフロー

モデルが追加、名前変更、または削除されるたびに、次のチェックリストを使用します。PR説明に結果を記録します（CIが使用されていない場合でも）。

1. **入力を収集**
   - プロバイダーの発表を確認し、サポートされている機能（ビジョン、推論、ツール使用など）を記録します。
   - 価格/使用階層は、デフォルト選択に影響する場合のみ決定します（それ以外の場合はドキュメントから除外）。

2. **`model_spec.js`を更新**
   - 正確なキー（プロバイダーの命名規則、通常は小文字でハイフン付きサフィックス）でエントリを追加または変更します。
   - `max_output_tokens`、`context_window`、および機能フラグを設定します。プロバイダーが最小/最大を指定する場合は範囲を使用し、オプションの場合は保守的なデフォルトを選択します。
   - 各プロバイダーセクション内でアルファベット順を維持して、差分ノイズを減らします。

3. **必要に応じてデフォルトを更新**
   - プロバイダーが新しいモデルをデフォルトで表示する場合、`docker/services/ruby/lib/monadic/utils/system_defaults.rb`と`app/main.js`のUIマッピングを更新します。
   - `docs/reference/configuration.md`および日本語版で新しい環境変数を文書化します。

4. **ドキュメントとサンプルを同期**
   - 機能セットが変更された場合のみ、`docs/features/custom-models.md`（EN/JA）のプレースホルダーまたは参照を置き換えます。
   - `docs/basic-usage/language-models.md`（EN/JA）がSKUリストを埋め込まずに公式プロバイダーページを指していることを確認します。
   - スキーマが変更された場合は`docs/examples/models.json.example`を更新します。

5. **関連テストを再生成**
   - フロントエンド：`test/frontend/model_spec.test.js`の期待値を調整します。
   - Ruby：機能カウントに依存する仕様を拡張または更新します（例：`spec/unit/api_models_endpoint_spec.rb`）。
   - Lintスクリプトを実行：`npm run lint:deprecated-models`。
   - 高速スイートをローカルで実行：`rake spec_unit`および`npm test`。API可視動作の場合、影響を受けるプロバイダーに対して`RUN_API=true rake spec_api:smoke`を実行します。

6. **廃止を監査**
   - プロバイダーがモデルを廃止する場合、`model_spec.js`から削除し、名前を`config/deprecated_model_terms.txt`に追加し、その用語で失敗を開始する場合はLintスクリプトを更新します。
   - 残存する参照を排除するためにドキュメント/サンプルをクリーンアップします。

## レビューチェックリスト

モデル更新をレビューする際、マージ前に以下を確認します：

- [ ] `model_spec.js`の構文が有効（`npm run build:model-spec`または`node -c`相当をパス）。
- [ ] デフォルトモデル選択が機能する（`ModelSpecUtils.default_for(provider)`が有効なキーを返す）。
- [ ] すべての必須ドキュメントと翻訳が更新されている。
- [ ] Lint（`npm run lint:deprecated-models`）と高速テスト（`rake spec_unit`、`npm test`）をローカルで実行し、結果をPR説明で共有。
- [ ] API smokeの説明に、該当する場合は新しい環境ノブを記載。

## 拡張のヒント

- **新しいプロバイダー**：`ModelSpecUtils.providers`にプロバイダーを追加し、`SystemDefaults`にデフォルトエントリを作成し、`ProviderMatrixHelper`マッピングを拡張し、認証情報変数を説明するドキュメントを追加することから始めます。すべてのアプリを配線する前に、単一のsmokeスペックでパイロットします。
- **新しい機能フラグ**：`model_spec.js`にフラグを導入し、`ModelSpecUtils`とUI（例：新しい推論プリセット用）に公開します。デフォルトを`false`にすることで下位互換性を維持します。
- **再利用可能なヘルパー**：複数のプロバイダーが類似した選択ロジック（例：「最新の日付付きバージョン」）を共有する場合、アダプターで条件を繰り返すのではなく、`ModelSpecUtils`にユーティリティを配置することを好みます。

## 運用ノート

- CIを実行しないため、各開発者は上記のコマンドを実行し、出力をPR説明でキャプチャする責任があります。
- ロールアウトがリスクであることが判明した場合、環境変数の背後に新しいデフォルトをゲートします（例：`OPENAI_ENABLE_X_MODEL`）。プロバイダーが本番環境で安定したら、ゲートを削除します。

## 付録

### 便利なコマンド

```bash
# Lintガードレールを検証
npm run lint:deprecated-models

# フロントエンドバンドルを再生成（model_specパースがまだ機能することを確認）
npm run build

# プロバイダーに対する焦点を絞ったAPI smokeテスト
RUN_API=true PROVIDERS=openai rake spec_api:smoke
```

### 連絡先

- **ModelSpecスチュワード**：プロバイダーの発表を追跡し、Lint用語の更新を所有します。
- **ドキュメントスチュワード**：ドキュメントがSKUフリーであり、翻訳が同期していることを確認します。

ワークフローまたはツールチェーンが変更されるたびに、このガイドを更新してください。
