# Video Generator Veo テスト

このテストスイートは、GoogleのVeo 2.0およびVeo 3.0 APIを使用して動画を生成する`video_generator_veo.rb`スクリプトをカバーします。

## テストカバレッジ

このテストは、実際のAPI呼び出しを行わずにすべての主要機能をカバーします：

### コア機能
- **APIキー取得**：設定ファイルからの読み取りをテスト
- **保存パスロジック**：ディレクトリの選択と作成をテスト
- **画像エンコーディング**：base64エンコーディングと検証をテスト
- **画像パス解決**：様々な場所での画像検索をテスト
- **動画生成**：モックAPIレスポンスを使用した完全なワークフローをテスト
- **操作ステータスチェック**：動画生成完了のポーリングをテスト
- **動画保存**：ダウンロードとプレースホルダー作成をテスト
- **コマンドライン解析**：新しいVeo 3機能を含むオプション検証をテスト
- **モデル選択**：Veo 2.0とVeo 3.0間の自動選択をテスト
- **ネガティブプロンプト**：Veo 3のネガティブプロンプト機能をテスト
- **高速モード**：Veo 3の高速生成モードをテスト

### エラーハンドリング
- 無効なAPIレスポンス
- ネットワークタイムアウト
- ファイルI/Oエラー
- 無効なコマンドライン引数
- 過大な画像
- 設定の欠落

## テストの実行

```bash
cd docker/services/ruby
bundle exec rspec spec/unit/scripts/generators/video_generator_veo_spec.rb
```

## 実装ノート

1. **API呼び出しなし**：すべてのHTTPリクエストはAPIコストを避けるためにモック化
2. **ファイル操作**：ファイルI/Oはテストアーティファクトの作成を避けるためにモック化
3. **出力の抑制**：STDOUTとSTDERRはテスト中にキャプチャ
4. **戻り値の形式**：スクリプトは異なるキータイプのハッシュを返します：
   - `process_generation_response`からのエラーレスポンスにはシンボルキー
   - `process_operation_result`からの成功レスポンスには文字列キー
5. **モデル選択**：
   - Veo 2.0は画像から動画への生成に使用
   - Veo 3.0はテキストから動画への生成に使用（設定可能）
   - Veo 3.0 Fastモデルはより速い生成に利用可能
6. **Veo 3.0機能**：
   - 同期された音声を持つ8秒720p動画を生成
   - 不要な要素を除外するネガティブプロンプトをサポート
   - 高速モードは速度のために品質をトレードオフ

## テスト戦略

このテストは、モック化のためにRSpecのdoubleとallow/receiveメソッドを使用します：
- HTTPレスポンスは適切なステータスコードとボディでモック化
- ファイル操作は実際のディスクI/Oを避けるためにスタブ化
- テストは副作用なしで動作を検証
